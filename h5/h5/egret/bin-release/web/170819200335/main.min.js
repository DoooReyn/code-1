function Singleton(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return t.__singleton__?t.__singleton__:(t.__singleton__=new(t.bind.apply(t,[void 0].concat(e))),t.__singleton__)}var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},__awaiter=this&&this.__awaiter||function(t,e,i,o){return new(i||(i=Promise))(function(n,r){function s(t){try{h(o.next(t))}catch(e){r(e)}}function a(t){try{h(o["throw"](t))}catch(e){r(e)}}function h(t){t.done?n(t.value):new i(function(e){e(t.value)}).then(s,a)}h((o=o.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return o([t,e])}}function o(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(s=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[0,s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(s=a.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(o){i=[6,o],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var n,r,s,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return{next:i(0),"throw":i(1),"return":i(2)}},__decorate=this&&this.__decorate||function(t,e,i,o){var n,r=arguments.length,s=3>r?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,i,o);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(s=(3>r?n(s):r>3?n(e,i,s):n(e,i))||s);return r>3&&s&&Object.defineProperty(e,i,s),s},events;!function(t){var e=function(){function t(t,e,i){this.name=t,this.tracer=i,this.callback=e}return t.prototype.dispose=function(){this.unbind()},t.prototype.cancel=function(){this.unbind()},t.prototype.bind=function(t,e){this.eventSet=t,this.data=e,this.tracer.bind(this)},t.prototype.unbind=function(){this.tracer.unbind(this),this.eventSet&&this.eventSet.unbind(this,this.data)},t.prototype.fire=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.callback.apply(this,t)!==!1},t.prototype.getName=function(){return this.name},t}();t.Event=e,__reflect(e.prototype,"events.Event");var i=function(){function t(){this.events=new Map}return t.prototype.dispose=function(){this.events.forEach(function(t,e){return e.dispose()})},t.prototype.bind=function(t){this.events.set(t,t)},t.prototype.unbind=function(t){this.events["delete"](t)},t.prototype.clear=function(){this.events.forEach(function(t,e){return e.unbind()})},t.prototype.exist=function(t){for(var e,i=this.events.keys()[Symbol.iterator]();!(e=i.next()).done;)if(e.value.getName()===t)return!0;return!1},t.prototype.cancel=function(t){for(var e,i=this.events.keys()[Symbol.iterator]();!(e=i.next()).done;)if(e.value.getName()===t)return e.value.unbind()},t}();t.EventTracer=i,__reflect(i.prototype,"events.EventTracer");var o=function(){function t(){this.events={}}return t.prototype.dispose=function(){},t.prototype.bind=function(t,e){var i=this.events[e];i||(i=[],this.events[e]=i),i.push(t),t.bind(this,e)},t.prototype.unbind=function(t,e){if(this.events[e]){var i=this.events[e].indexOf(t);i>=0&&this.events[e].splice(i,1)}},t.prototype.fire=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(!this.events[t])return!1;for(var o=!1,n=this.events[t].slice(0,this.events[t].length),r=0,s=n;r<s.length;r++){var a=s[r];o=a.fire.apply(a,e)||o}return o},t}();t.EventSet=o,__reflect(o.prototype,"events.EventSet",["events.EventHandle"]);var n=function(){function t(){}return t.prototype.initTracer=function(){this.eventTracer=new i},t.prototype.disposeTracer=function(){this.eventTracer.dispose()},t.prototype.Event=function(t,i){var o=this;if(i=i||t,t&&this.eventTracer.exist(t)&&(console.log("!!!!!!!Warning: Dumplicate Event Name: "+t),this.eventTracer.cancel(t)),"string"==typeof i){var n=i;i=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return(i=o[n]).call.apply(i,[o].concat(t));var i}}else{var r=i;i=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return r.call.apply(r,[o].concat(t))}}return new e(t,i,this.eventTracer)},t.prototype.EventTracer=function(){return this.eventTracer},t}();t.Tracer=n,__reflect(n.prototype,"events.Tracer");var r=function(){function t(){this.initTracer(),this.eventSet=new o}return t.prototype.dispose=function(){this.eventSet.dispose(),this.disposeTracer()},t.prototype.on=function(t,e){this.eventSet.bind(e,t)},t.prototype.off=function(t,e){this.eventSet.unbind(e,t)},t.prototype.fireEvent=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return(o=this.eventSet).fire.apply(o,[t].concat(e));var o},t}();t.Base=r,__reflect(r.prototype,"events.Base"),eui.sys.mixin(r,events.Tracer)}(events||(events={}));var mo;!function(t){var e=function(){function t(t,e,i,o){this.map=t,this.name=e,this.layerIdx=i,this.data=o,this.dataSource=t.getData();var n=t.getNode();this.node=new eui.Group,this.node.width=n.width,this.node.height=n.height,n.addChild(this.node),this.node.name=this.name}return t.prototype.dispose=function(){},t.prototype.viewportChanged=function(t,e,i){},t.prototype.getName=function(){return this.name},t}();t.Layer=e,__reflect(e.prototype,"mo.Layer")}(mo||(mo={}));var UIBase=function(t){function e(e){var i=t.call(this)||this;return i.custom=e,i.includeInLayout=!0,i.addEventListener(eui.UIEvent.COMPLETE,i.createCompleteEvent,i),i.skinName=e.skinName,i}return __extends(e,t),e.prototype.createCompleteEvent=function(t){this.removeEventListener(eui.UIEvent.COMPLETE,this.createCompleteEvent,this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onEnter,this),this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.onExit,this),this.bindControl()},e.prototype.removeFromParent=function(){this.parent.removeChild(this)},e.prototype.onClose=function(){this.removeFromParent()},e.prototype.onEnter=function(){this.initTracer(),this.addSizeListener(),this.buildCloseBg()},e.prototype.addSizeListener=function(){this.parent.addEventListener(egret.Event.RESIZE,this.onReSize,this),t=[this.parent.width,this.parent.height],this.width=t[0],this.height=t[1];var t},e.prototype.onExit=function(){this.parent.removeEventListener(egret.Event.RESIZE,this.onReSize,this),this.disposeTracer()},e.prototype.onReSize=function(){t=[this.parent.width,this.parent.height],this.width=t[0],this.height=t[1];var t},e.prototype.fireUIEvent=function(t,e){UIMgr.fireUIEvent(t,e)},e.prototype.bindUIEvent=function(t,e){this.addEventListener(t,e,this)},e.prototype.bindControl=function(){for(var t in this.custom.binding||{}){var e=this.custom.binding[t];if(this[e.method]){for(var i=t.split("."),o=this,n=0,r=i;n<r.length;n++){var s=r[n];if(!o)break;o=o[s]}if(o){var a=e.event||egret.TouchEvent.TOUCH_TAP;o.addEventListener(a,this[e.method],this)}else console.log("### Not Found Binding: "+t+" -- SkinName: "+this.custom.skinName)}else console.log("### Not Found Method: "+e.method+" -- SkinName: "+this.custom.skinName)}},e.prototype.buildCloseBg=function(){if(this.custom.closeBg){var t=new eui.Group;if(t.top=t.bottom=t.left=t.right=0,this.addChildAt(t,0),this.custom.closeBg.disable||t.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this),0!==this.custom.closeBg.alpha){var e=new eui.Rect(t.width,t.height);e.top=e.bottom=e.left=e.right=0,e.alpha=this.custom.closeBg.alpha||.5,t.addChild(e)}}},e}(eui.Component);__reflect(UIBase.prototype,"UIBase"),eui.sys.mixin(UIBase,events.Tracer);var NetMsg=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.proto="proto_proto",e}return __extends(e,t),e.prototype.init=function(t){this.netCenter=t,this.nameIds={};for(var e in this.subIds){var i=this.subIds[e];this.nameIds[i]=parseInt(e)}},e.prototype.on=function(e,i){t.prototype.on.call(this,e,i)},e.prototype.getModId=function(){return this.modId},e.prototype.send=function(t,e){void 0===e&&(e={}),console.log("+++++++ Send Msg: ["+this.__class__+" : "+t+"] +++++++",e);var i=this.nameIds[t],o=this.pack(i,e),n=100*this.modId+i;return this.netCenter.sendMessage(n,o)},e.prototype.onRecv=function(t,e){var i=Math.floor(t%100),o=this.unpack(i,e);console.log("======= Recv Msg: ["+this.__class__+" : "+this.subIds[i]+"] =======",o),this.fireEvent(this.subIds[i],o)},e.prototype.pack=function(t,e){var i=RES.getRes(this.proto),o=protobuf.parse(i,{keepCase:!0}).root,n=o.lookupType(this.subIds[t]),r=n.verify(e);if(r)throw new Error(r);var s=n.create(e),a=n.encode(s).finish(),h=a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength);return h},e.prototype.unpack=function(t,e){var i=RES.getRes(this.proto),o=protobuf.parse(i,{keepCase:!0}).root,n=o.lookupType(this.subIds[t]);return n.decode(new Uint8Array(e))},e}(events.Base);__reflect(NetMsg.prototype,"NetMsg");var world;!function(t){var e=function(){function t(t,e,i){this.manager=t,this.data=i,this.root=e,this.worldMap=t.getWorldMap();var o=this.worldMap.getInfo();this.cellSize={width:o.cw,height:o.ch},this.view=this.build(),this.root.addChild(this.view),this.refresh()}return t.prototype.dispose=function(){this.destroy()},t.prototype.createView=function(t){var e=new egret.DisplayObjectContainer;this.centerView(e);var i=RES.getRes(t),o=new eui.Image(i);return e.addChild(o),o.touchEnabled=!1,o.width=i.bitmapData.width,o.height=i.bitmapData.height,this.alignLeftBottom(o),e},t.prototype.centerView=function(t){e=[this.cellSize.width,this.cellSize.height],t.width=e[0],t.height=e[1],t.anchorOffsetX=t.width/2,t.anchorOffsetY=t.height/2;var e},t.prototype.alignLeftBottom=function(t){var e=t.parent;t.y+=e.height-t.height},t.prototype.refresh=function(){var t=this.worldMap.cell2world(this.data.x,this.data.y);e=[t[0],t[1]],this.view.x=e[0],this.view.y=e[1];var e},t.prototype.build=function(){return null},t.prototype.destroy=function(){this.root.removeChild(this.view),this.view=null},t.prototype.setData=function(t){this.data=t},t.prototype.getData=function(){return this.data},t.prototype.getView=function(){return this.view},t}();t.ViewBase=e,__reflect(e.prototype,"world.ViewBase",["IView"])}(world||(world={}));var IRBase=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.addSizeListener=function(){},e.prototype.enableTouch=function(){this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this)},e}(UIBase);__reflect(IRBase.prototype,"IRBase",["eui.IItemRenderer","eui.UIComponent","egret.DisplayObject"]),eui.sys.mixin(IRBase,eui.ItemRenderer);var Logic=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(events.Base);__reflect(Logic.prototype,"Logic");var PlayerView=function(t){function e(i){var o=t.call(this)||this;return o.vo=new PlayerVO,o.vo_temp=new PlayerVO,o.is8Dir=!0,o.acName=["idle","run","attack"],o.acDir=["up","up_45","right","down_45","down","down_45","right","up_45"],o.acNameIndex=0,o.acDirIndex=0,o.timeOnEnterFrame=0,o.needChangeAction=!1,o.moveSpeed=.25,o.moveTimeOneCell=2e3,o.moveSpeedX=0,o.moveSpeedY=0,o.moveDisX=0,o.moveDisY=0,o.targetX=0,o.targetY=0,o.actions=[],o.moveIndex=0,o.move_path=[],o.points=[],o.queueFollowMaxFrameLength=150,o.saveAllFollowFrame=200,o.goToTargetCallBack=void 0,o.width=mo.TMap.getMainData().getResult().info.cw,o.height=mo.TMap.getMainData().getResult().info.ch,o.anchorOffsetX=o.width/2,o.anchorOffsetY=o.height/2,o.init(),o.root=i,e.static_index++,o.shape=new egret.Shape,o.root.addChild(o.shape),o}return __extends(e,t),e.prototype.atttack=function(t){var e=this;if(this.getAttackView()){for(var i=t.damage_info_list,o=i.defender_hp,n=i.damage,r=function(t){var i=s.actions[t];i.hasEventListener(egret.Event.LOOP_COMPLETE)?console.log("存在事件..."):(console.log("不存在事件..."),i.addEventListener(egret.Event.LOOP_COMPLETE,function(t){e.setAcNameIndex(0),i.movieClipData=e.mcDataFactory.generateMovieClipData(e.acName[e.acNameIndex]+"_"+e.acDir[e.acDirIndex]),i.gotoAndPlay(1,-1)},s))},s=this,a=0;a<this.actions.length;a++)r(a);var h=this.getAttackView();h.hurtAndRefresh(n),h.vo.setCurHp(o),Prompt.popTip(h.getVO().getId()+"掉血"+n),this.setAcNameIndex(2),this.playAction()}},e.prototype.updateVO=function(t,e){this.vo=t,this.vo_temp=e,i=this.vo.getXY(),this.x=i[0],this.y=i[1];var i},e.prototype.getVO=function(){return this.vo},e.prototype.getVO_temp=function(){return this.vo_temp},e.prototype.setAcDirIndex=function(t){this.acDirIndex!==t&&(this.needChangeAction=!0,this.acDirIndex=t)},e.prototype.setAcNameIndex=function(t){this.acNameIndex!==t&&(this.needChangeAction=!0,this.acNameIndex=t)},e.prototype.getAcDirIndex=function(){return this.acDirIndex},e.prototype.getAcNameIndex=function(){return this.acNameIndex},e.prototype.setAttackView=function(t){this.attackView=t},e.prototype.getAttackView=function(){return this.attackView},e.prototype.setMoveSpeed=function(t){this.moveSpeed=t},e.prototype.getMoveSpeed=function(){return this.moveSpeed},e.prototype.init=function(){this.createPlayer()},e.prototype.createPlayer=function(){this.initMovieClip()},e.prototype.initMovieClip=function(){this._mcData=RES.getRes("role_"+this.vo.getModelId()+"_json"),this._mcTexture=RES.getRes("role_"+this.vo.getModelId()+"_png"),this.mcDataFactory=new egret.MovieClipDataFactory(this._mcData,this._mcTexture);var t=this.vo.getUnitCount();this.acDirIndex=Math.floor(10*Math.random()%7);var e=UIMgr.getWorld().getMap().createCoordinate(Math.sqrt(t),0,0);this.info=e.getInfo();for(var i=0;t>i;i++){var o=new egret.MovieClip(this.mcDataFactory.generateMovieClipData(this.acName[this.acNameIndex]+"_"+this.acDir[this.acDirIndex]));this.addChild(o),o.scaleX=.7,o.scaleY=.7,this.actions.push(o);var n=e.index2cell(i),r=n[0],s=n[1],a=e.cell2world(r,s),h=a[0],l=a[1];o.x=h,o.y=l,o.gotoAndPlay(1,-1)}this.progressBar=new ProgressBar,this.progressBar.setProgress(this.vo.getPecentHp());var c=.4;this.progressBar.scaleX=c,this.progressBar.scaleY=c,this.progressBar.anchorOffsetX=this.progressBar.width/2,this.progressBar.x=this.width/2,this.addChild(this.progressBar)},e.prototype.updatePath=function(t){this.move_path=t.move_path,this.moveIndex=0,this.moveOnePath()},e.prototype.moveOnePath=function(){var t=this.move_path[this.moveIndex].x,e=this.move_path[this.moveIndex].y;this._moveOnePath(t,e)},e.prototype._moveOnePath=function(t,e,i){this.goToTargetCallBack=i;var o=UIMgr.getWorld().getMap().cell2world(t,e),n=o[0],r=o[1];if(this.vo.setCellXY(t,e),n!==this.x||r!==this.y){this.stage.removeEventListener(egret.Event.ENTER_FRAME,this.bgMove,this),this.setAcNameIndex(1),this.targetX=n,this.targetY=r;var s=Math.abs(this.targetX-this.x),a=Math.abs(this.targetY-this.y);this.towPointDis=Math.sqrt(s*s+a*a);var h=UIMgr.getWorld().getMap().world2cell(this.x,this.y),l=h[0],c=h[1],p=Math.abs(t-l),u=Math.abs(e-c);this.towPointCellNum=p>u?p:u,this.moveDisX=n-this.x,this.moveDisY=r-this.y;var d=Math.sqrt(this.moveDisX*this.moveDisX+this.moveDisY*this.moveDisY);this.moveSpeedX=this.moveDisX/d*this.moveSpeed,this.moveSpeedY=this.moveDisY/d*this.moveSpeed,this.setAcDirIndex(this.calculateDir(this.moveDisX,this.moveDisY,d)),this.playAction(),this.timeOnEnterFrame=egret.getTimer(),this.stage.addEventListener(egret.Event.ENTER_FRAME,this.bgMove,this),this.moveIndex++}},e.prototype.calculateDis=function(){},e.prototype.calculateSpeed=function(t){return this.towPointDis/(this.moveTimeOneCell*this.towPointCellNum)*t},e.prototype.calculateDir=function(t,e,i){var o=0;if(t>=0)if(e>=0){var n=utils.MahtSin(e,i);o=n+90}else{var n=utils.MahtSin(e,i);o=n+90}else if(e>0){var n=utils.MahtSin(t,i);o=Math.abs(n)+180}else{var n=utils.MahtSin(t,i);o=360+n}o=(o+22.5)%361;var r=Math.ceil(o/45);return r-1},e.prototype.bgMove=function(t){var e=(egret.getTimer(),this.timeOnEnterFrame,1.1);this.setMoveSpeed(e);var i=Math.sqrt(this.moveDisX*this.moveDisX+this.moveDisY*this.moveDisY);this.moveSpeedX=this.moveDisX/i*this.moveSpeed,this.moveSpeedY=this.moveDisY/i*this.moveSpeed,this.moveUpdate(),this.timeOnEnterFrame=egret.getTimer()},e.prototype.moveUpdate=function(){this.x+=this.moveSpeedX,this.y+=this.moveSpeedY,this.vo.setX(this.x),this.vo.setY(this.y),this.recordMovePath(this.x,this.y,this.acDirIndex),this.chectReach(this.x,this.y,this.targetX,this.targetY)},e.prototype.drawLine=function(){this.shape.graphics.clear(),this.shape.graphics.lineStyle(2,65280),this.shape.graphics.moveTo(this.x,this.y);for(var t=0,e=this.move_path;t<e.length;t++){var i=e[t],o=i,n=UIMgr.getWorld().getMap().cell2world(o.x,o.y),r=n[0],s=n[1];this.shape.graphics.lineTo(r,s)}this.shape.parent.getChildIndex(this.shape);this.shape.parent.setChildIndex(this.shape,0);this.shape.parent.getChildIndex(this.shape);this.shape.graphics.endFill()},e.prototype.playAction=function(t){if(this.needChangeAction||t){this.needChangeAction=!1;var e,i=this.acDirIndex;e=5===i||6===i||7===i,this._playAction(e,t)}},e.prototype._playAction=function(t,e){for(var i=0;i<this.actions.length;i++){var o=this.actions[i];t?o.scaleX=-Math.abs(o.scaleX):o.scaleX=Math.abs(o.scaleX),o.movieClipData=this.mcDataFactory.generateMovieClipData(this.acName[this.acNameIndex]+"_"+this.acDir[this.acDirIndex]),o.gotoAndPlay(1,e?0:-1)}},e.prototype.ReachToChangeAction=function(){this.moveIndex>=this.move_path.length?(this.stage.removeEventListener(egret.Event.ENTER_FRAME,this.bgMove,this),this.setAcNameIndex(0),this.playAction(),void 0!==this.goToTargetCallBack&&(this.goToTargetCallBack(this),this.goToTargetCallBack=void 0),console.log("到达目的地...切换待机状态... ")):console.log("走完 等待服务器返回...... ")},e.prototype.chectReach=function(t,e,i,o){switch(this.acDirIndex){case 0:case 1:case 7:o>=e&&this.ReachToChangeAction();break;case 3:case 4:case 5:e>o&&this.ReachToChangeAction();break;case 2:t>=i&&this.ReachToChangeAction();break;case 6:i>=t&&this.ReachToChangeAction()}return!1},e.prototype.setFrontRoleView=function(t){this.frontRole=t,this.stage.addEventListener(egret.Event.ENTER_FRAME,this.followMove,this)},e.prototype.getFrontRoleView=function(){return this.frontRole},e.prototype.disFrontRoleView=function(){this.frontRole=void 0,this.stage.removeEventListener(egret.Event.ENTER_FRAME,this.followMove,this)},e.prototype.followMove=function(){var t=this.getRecordPrevious();t?(this.setAcNameIndex(1),this.moveUpdateFollow(t.x,t.y,t.dir)):(this.setAcNameIndex(0),this.playAction())},e.prototype.recordMovePath=function(t,e,i){for(var o=new Mpoint(t,e,i);this.points.length>=this.saveAllFollowFrame;)this.points.splice(0,1);this.points.push(o)},e.prototype.getRecordPrevious=function(){return this.getFrontRoleView().points.length<this.queueFollowMaxFrameLength?void 0:this.getFrontRoleView().points.splice(0,1)[0]},e.prototype.moveUpdateFollow=function(t,e,i){this.x=t,this.y=e,this.setAcDirIndex(i),this.vo.setX(this.x),this.vo.setY(this.y);var o=UIMgr.getWorld().getMap().world2cell(this.x,this.y),n=o[0],r=o[1];this.vo.setCellXY(n,r),this.recordMovePath(this.x,this.y,this.acDirIndex),this.playAction()},e.prototype.hurtAndRefresh=function(t){this.vo.setCurHp(this.vo.getCurHp()-t),this.progressBar.setProgress(this.vo.getPecentHp());for(;(this.actions.length-1)*(100/this.vo.getUnitCount())/100>=this.vo.getPecentHp();){var e=this.actions.splice(this.actions.length-1,1)[0];e.parent.removeChild(e),console.log("倒下一个..... = "+this.actions.length)}this.actions.length<=0&&(console.log("该方阵死亡..........!!!"+typeof this),this.dispose())},e.prototype.dispose=function(){this.stage.removeEventListener(egret.Event.ENTER_FRAME,this.followMove,this),this.stage.removeEventListener(egret.Event.ENTER_FRAME,this.bgMove,this),this.parent.removeChild(this)},e}(egret.DisplayObjectContainer);PlayerView.static_index=0,__reflect(PlayerView.prototype,"PlayerView");var Mpoint=function(){function t(t,e,i){this.x=t,this.y=e,this.dir=i}return t}();__reflect(Mpoint.prototype,"Mpoint");var PlayerVO=function(){function t(){this.modelId=1002,this.cellX=0,this.cellY=0,this.curHp=5e3,this.maxHp=5e3,this.unitCount=4}return t.prototype.setId=function(t){this.id=t},t.prototype.getId=function(){return this.id},t.prototype.setModelId=function(t){this.modelId=t},t.prototype.getModelId=function(){return this.modelId},t.prototype.setName=function(t){this.name=t},t.prototype.getName=function(){return this.name},t.prototype.setX=function(t){this.x=t},t.prototype.getX=function(){return this.x},t.prototype.setY=function(t){this.y=t},t.prototype.getY=function(){return this.y},t.prototype.setXY=function(t,e){this.x=t,this.y=e},t.prototype.getXY=function(){return[this.x,this.y]},t.prototype.setCellX=function(t){this.cellX=t},t.prototype.getCellX=function(){return this.cellX},t.prototype.setCellY=function(t){this.cellY=t},t.prototype.getCellY=function(){return this.cellY},t.prototype.setCellXY=function(t,e){this.cellX=t,this.cellY=e},t.prototype.getCellXY=function(){return[this.cellX,this.cellY]},t.prototype.setMoveSpeed=function(t){this.moveSpeed=t},t.prototype.getMoveSpeed=function(){return this.moveSpeed},t.prototype.setCurHp=function(t){this.curHp=0>t?0:t},t.prototype.getCurHp=function(){return this.curHp},t.prototype.setMaxHp=function(t){},t.prototype.getMaxHp=function(){return this.maxHp},t.prototype.getPecentHp=function(){return this.curHp/this.maxHp},t.prototype.setUnitCount=function(t){this.unitCount=t},t.prototype.getUnitCount=function(){return this.unitCount},t}();__reflect(PlayerVO.prototype,"PlayerVO");var mo;!function(t){var e=function(e){function i(i,o,n,r,s){var a=e.call(this,i,o,n,s)||this,h=r.getViewSize();return a.strategy=new t.Tile(h,s.bgInfo.size,a.node,function(){var t=new eui.Group,e=new eui.Image(s.bgInfo.url);return t.addChild(e),t.alpha=.5,t}),a}return __extends(i,e),i.prototype.dispose=function(){e.prototype.dispose.call(this)},i.prototype.viewportChanged=function(t,e,i){this.strategy.update(t,e)},i}(t.Layer);t.Background=e,__reflect(e.prototype,"mo.Background")}(mo||(mo={}));var mo;!function(t){var e=function(e){function i(i,o,n,r,s,a){var h=e.call(this,i,o,n,s)||this,l=h;return h.dynamicCells=a,h.pool={},h.strategy=new t.Dynamic(i,h.node,h.dynamicCells,function(t){var e=h.dataSource.getCellTile(t,h.layerIdx);if(void 0!==e){var i=h.getTileKey(e);if(h.pool[i]&&h.pool[i].length>0)return h.pool[i].pop();var o=h.getSprite(e,i,t,l.data.info);o.y+=l.data.info.ch-o.height;var n=new eui.Group;return n.addChild(o),n.width=l.data.info.cw,n.height=l.data.info.ch,n.anchorOffsetX=n.width/2,n.anchorOffsetY=n.height/2,n.name=i,n}},function(t,e){var i=t.name;h.pool[i]=h.pool[i]||[],h.pool[i].push(t)}),h}return __extends(i,e),i.prototype.dispose=function(){e.prototype.dispose.call(this)},i.prototype.getTileKey=function(t){var e=t.rect;return t.image+":"+e.x+"-"+e.y},i.prototype.getSprite=function(t,e,i,o){var n=t.image.replace(".","_"),r=RES.getRes(n),s=new egret.Bitmap(r),a=new egret.SpriteSheet(s.texture),h=t.rect,l=a.getTexture(e);l||(l=a.createTexture(e,h.x,h.y,h.width,h.height));var c=new eui.Image(l);return p=[t.offsetX,t.offsetY],c.x=p[0],c.y=p[1],u=[h.width,h.height],c.width=u[0],c.height=u[1],c;var p,u},i.prototype.viewportChanged=function(t,e,i){this.strategy.update(t,e,i),this.dynamicCells.isNeedUpdate()&&this.map.callUpdateCallback(this.dynamicCells.getCells(),this.getName())},i.prototype.getCellNode=function(t,e){return this.strategy.getCellNode(t,e)},i}(t.Layer);t.TileLayer=e,__reflect(e.prototype,"mo.TileLayer")}(mo||(mo={}));var ui;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.play=function(t,i,o,n,r){void 0===n&&(n=!0),void 0===r&&(r=0);var s=e.create(t);return s.then(function(t){return o.addChild(t),t}),s.then(function(t){return t.play(i,n,r)})},e.create=function(t){var i=this,o=new e;return new Promise(function(e,n){o.once(eui.UIEvent.COMPLETE,function(){return e(o)},i),o.skinName=t})},e.prototype.play=function(t,e,i){var o=this;void 0===e&&(e=!0),void 0===i&&(i=0),this.verticalCenter=0,this.horizontalCenter=0;var n=this[t];return n.play(i),new Promise(function(t,i){n.once("complete",function(){e&&o.parent&&o.parent.removeChild(o),t()},o)})},e.prototype.playLoop=function(t,e){var i=this;void 0===e&&(e=0),this.verticalCenter=0,this.horizontalCenter=0;var o=this[t];o.play(e),o.hasEventListener("complete")||o.addEventListener("complete",function(){return i.playLoop(t,e)},this)},e.prototype.hasAnimation=function(t){var e=this[t];return e instanceof egret.tween.TweenGroup?!0:!1},e}(eui.Component);t.Animat=e,__reflect(e.prototype,"ui.Animat");var i=function(){function t(){}return t.prototype.hasAnimation=function(t){var e=this[t];return e instanceof egret.tween.TweenGroup?!0:!1},t.prototype.playAnimationLoop=function(t,e){var i=this;void 0===e&&(e=0);var o=this[t];if(!(o instanceof egret.tween.TweenGroup))throw new Error("Animation "+t+" is not a TweenGroup");o.play(e),o.hasEventListener("complete")||(this._tweenCache_=this._tweenCache_||{},this._tweenCache_[t]=function(){i.playAnimationLoop(t,e)},o.addEventListener("complete",this._tweenCache_[t],this))},t.prototype.stopAnimationLoop=function(t,e){void 0===e&&(e=!0);var i=this[t];if(!(i instanceof egret.tween.TweenGroup))throw new Error("Animation "+t+" is not a TweenGroup");e&&i.play(0),i.stop(),this._tweenCache_=this._tweenCache_||{},i.removeEventListener("complete",this._tweenCache_[t],this)},t.prototype.playAnimation=function(t,e){void 0===e&&(e=0);var i=this[t];if(!(i instanceof egret.tween.TweenGroup))throw new Error("Animation "+t+" is not a TweenGroup");!i.hasEventListener("complete")&&this.onTweenGroupComplete&&i.addEventListener("complete",this.onTweenGroupComplete,this),!i.hasEventListener("itemComplete")&&this.onTweenItemComplete&&i.addEventListener("itemComplete",this.onTweenItemComplete,this),i.play(e)},t}();t.AnimatImpl=i,__reflect(i.prototype,"ui.AnimatImpl")}(ui||(ui={}));var utils;!function(t){function e(t){var e=[.3,.6,0,0,0,.3,.6,0,0,0,.3,.6,0,0,0,0,0,0,1,0],i=new egret.ColorMatrixFilter(e);t.filters=[i]}function i(t){var e=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],i=new egret.ColorMatrixFilter(e);t.filters=[i]}function o(t,e){var i=[0,0,0,0,e.r||0,0,0,0,0,e.g||0,0,0,0,0,e.b||0,0,0,0,1,e.a||0],o=new egret.ColorMatrixFilter(i);t.filters=[o]}function n(t,e){var i=[e.rr,0,0,0,0,0,e.gr,0,0,0,0,0,e.br,0,0,0,0,0,1,0],o=new egret.ColorMatrixFilter(i);t.filters=[o]}t.setGray=e,t.resetColor=i,t.setColor=o,t.setColorR=n}(utils||(utils={}));var utils;!function(t){function e(t){for(var e={},i=0,o=0,n=t;o<n.length;o++){var r=n[o];e[r]=i++}return e}function i(t,e){for(var i={},o=0,n=t;o<n.length;o++){var r=n[o],s=e(r);i[s]=r}return i}function o(t,e){var i={};for(var o in t)e[o]&&(i[o]=t[o]);return i}function n(t,e){for(var i in t)e[i]=t[i];return e}function r(t){var e=new egret.Timer(t,1);return new Promise(function(t,i){e.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){return t(e)},e),e.start()})}function s(t,e,i){var o=new egret.Timer(t,1);return o.addEventListener(egret.TimerEvent.TIMER_COMPLETE,e,i),o.start(),o}function a(t,e,i){var o=new egret.Timer(t);return o.addEventListener(egret.TimerEvent.TIMER,e,i),o.start(),o}t.Enum=e,t.convert2Object=i,t.intersectObject=o,t.mergeObject=n,t.afterAsync=r,t.after=s,t.repeat=a}(utils||(utils={}));var mo;!function(t){var e={ground:t.TileLayer,background:t.Background},i=function(){function i(e,i,o){this.map=e,this.dynamicCells=new t.DynamicCells(e),this.layers=[];for(var n=0,r=0,s=o.layers||[];r<s.length;r++){var a=s[r],h=this.createLayer(i,a,n++,o);this.layers.push(h)}}return i.prototype.dispose=function(){for(var t=0,e=this.layers;t<e.length;t++){var i=e[t];i.dispose()}},i.prototype.viewportChanged=function(t,e){if(this.dynamicCells.update(t,e),this.dynamicCells.isNeedUpdate()){var i={cells:this.dynamicCells.getCells(),keys:this.dynamicCells.getCellsKey()};this.updateLayer(t,e,i),this.map.callUpdateCallbackByDefault(this.dynamicCells.getCells())}},i.prototype.updateLayer=function(t,e,i){var o=this,n=this.dynamicCells.getCellFiles();this.map.canelNextFrame();var r=function(){return o.update(t,e,i)};this.map.getData().loadAllDataFiles(n,r)},i.prototype.update=function(t,e,i){var o=this,n=function(){for(var n=0,r=o.layers;n<r.length;n++){var s=r[n];s.viewportChanged(t,e,i)}};this.map.callNextFrame(n,this)},i.prototype.getLayerNames=function(){for(var t=[],e=0,i=this.layers;e<i.length;e++){var o=i[e];t.push(o.getName())}return t},i.prototype.createLayer=function(i,o,n,r){var s=e[o]||t.TileLayer;if(void 0!==s&&null!==s)return new s(this.map,o,n,i,r,this.dynamicCells)},i}();t.Layers=i,__reflect(i.prototype,"mo.Layers")}(mo||(mo={}));var ProtoAnalyzer={onLoadStart:function(t,e){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(o){switch(o.label){case 0:return[4,t.load(e,RES.processor.TextProcessor)];case 1:return i=o.sent(),[2,i]}})})},onRemoveStart:function(t,e){return Promise.resolve()}},ProgressBar=function(t){function e(){var e=t.call(this)||this;e.reverse=!1;var i="xuetiao_back_png",o="xuetiao01_png";return e.background=new egret.Bitmap(RES.getRes(i)),e.bar=new egret.Bitmap(RES.getRes(o)),e.addChild(e.background),e.addChild(e.bar),e.bar.x=(e.background.width-e.bar.width)/2,e.bar.y=(e.background.height-e.bar.height)/2,e.barMask=new egret.Rectangle(0,0,e.bar.width,e.bar.height),e.bar.mask=e.barMask,e}return __extends(e,t),e.prototype.setProgress=function(t){this.barMask=new egret.Rectangle(0,0,(this.reverse?1-t:t)*this.bar.width,this.bar.height),this.bar.mask=this.barMask},e}(egret.Sprite);__reflect(ProgressBar.prototype,"ProgressBar");var MonsterView=function(t){function e(){var i=t.call(this)||this;return e.instance=i,i}return __extends(e,t),e.getMonster=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.createChildren=function(){this.autoMove()},e.prototype.autoMove=function(){RoleView.getRoleView().vo},e}(PlayerView);__reflect(MonsterView.prototype,"MonsterView");var RoleView=function(t){function e(i){var o=t.call(this,i)||this;return e.instance=o,o.touchEnabled=!1,o.width=o.info.w,o.height=o.info.h,o.anchorOffsetX=o.width/2,o.anchorOffsetY=o.height/2,o}return __extends(e,t),e.getRoleView=function(){return e.instance||(e.instance=new e),e.instance},e}(PlayerView);__reflect(RoleView.prototype,"RoleView");var PhalanxVO=function(){function t(){this.modelId=1001,this.curHp=1e3,this.maxHp=1e3,this.unitCount=4}return t.prototype.setId=function(t){this.id=t},t.prototype.getId=function(){return this.id},t.prototype.setModelId=function(t){this.modelId=t},t.prototype.getModelId=function(){return this.modelId},t.prototype.setName=function(t){this.name=t},t.prototype.getName=function(){return this.name},t.prototype.setX=function(t){this.x=t},t.prototype.getX=function(){return this.x},t.prototype.setY=function(t){this.y=t},t.prototype.getY=function(){return this.y},t.prototype.setXY=function(t,e){this.x=t,this.y=e},t.prototype.getXY=function(){return[this.x,this.y]},t.prototype.setMoveSpeed=function(t){this.moveSpeed=t},t.prototype.getMoveSpeed=function(){return this.moveSpeed},t.prototype.setCurHp=function(t){this.curHp=0>t?0:t},t.prototype.getCurHp=function(){return this.curHp},t.prototype.setMaxHp=function(t){},t.prototype.getMaxHp=function(){return this.maxHp},t.prototype.getPecentHp=function(){return this.curHp/this.maxHp},t.prototype.setUnitCount=function(t){this.unitCount=t},t.prototype.getUnitCount=function(){return this.unitCount},t}();__reflect(PhalanxVO.prototype,"PhalanxVO");var MapScroller=function(t){function e(){var e=t.call(this)||this;return e.scrollThreshold=5,e.subMaps=[],e.touchScrollH=new world.TouchScroll(e.horizontalUpdateHandler,e.horizontalEndHandler,e),e.touchScrollV=new world.TouchScroll(e.verticalUpdateHandler,e.verticalEndHanlder,e),e.touchScrollH.$bounces=!1,e.touchScrollV.$bounces=!1,e.touchScrollH.$scrollFactor=.3,e.touchScrollV.$scrollFactor=.3,e
}return __extends(e,t),e.prototype.horizontalUpdateHandler=function(t){var e=this.getCameraRange(t,this.map.y),i=e[0],o=e[1];this.updateMapPosition(i,o)},e.prototype.horizontalEndHandler=function(){},e.prototype.verticalUpdateHandler=function(t){var e=this.getCameraRange(this.map.x,t),i=e[0],o=e[1];this.updateMapPosition(i,o)},e.prototype.verticalEndHanlder=function(){},e.prototype.setPosWithCheckRange=function(t,e){var i=this.getCameraRange(t,e);this.updateMapPosition(i[0],i[1])},e.prototype.setPosWithAnimat=function(t,e,i,o){var n=[t-this.width/2,e-this.height/2],r=this.getCameraRange(n[0],n[1]);this.moveToMapPosition(r[0],r[1],i,o)},e.prototype.setCell2Center=function(t,e){var i=this.map.cell2world(t,e),o=[i[0]-this.width/2,i[1]-this.height/2],n=this.getCameraRange(o[0],o[1]);this.updateMapPosition(n[0],n[1])},e.prototype.getCenterWPos=function(t,e){return[t-this.width/2,e-this.height/2]},e.prototype.registScrollCallback=function(t){this.scrollCallback=t},e.prototype.setViewSize=function(t){this.width=t.width,this.height=t.height,this.map.setViewSize(t),this.map.update(),this.subMaps.map(function(e){return e.setViewSize(t)}),this.subMaps.map(function(t){return t.update()}),this.formulas=this.getLineFormulas(this.map,config.MAP_BORDER_OFFSET),this.border=this.getBorderCorner(this.formulas,this)},e.prototype.getMap=function(){return this.map},e.prototype.dispose=function(){this.map.dispose(),this.map=null,this.subMaps.map(function(t){return t.dispose()}),this.subMaps=[]},e.prototype.buildMap=function(t,e,i){function o(t){d=t.stageX,g=t.stageY,f=!1,p.addEventListener(egret.TouchEvent.TOUCH_MOVE,r,this),this.touchScrollH.stop(),this.touchScrollV.stop(),this.touchScrollH.start(t.stageX),this.touchScrollV.start(t.stageY)}function n(t){p.removeEventListener(egret.TouchEvent.TOUCH_MOVE,r,this),f||l.touchTap(t),this.touchScrollH.finish(this.map.x,0),this.touchScrollV.finish(this.map.y,0)}function r(t){return Math.abs(d-t.stageX)>this.scrollThreshold||Math.abs(g-t.stageY)>this.scrollThreshold?(this.touchScrollH.update(t.stageX,0,this.map.x),this.touchScrollV.update(t.stageY,0,this.map.y),void(f=!0)):void 0}var s=i,a=this;a.width=s.width,a.height=s.height,a.x=s.width/2,a.y=s.height/2,a.anchorOffsetX=a.width/2,a.anchorOffsetY=a.height/2,s.addChild(a);var h=Singleton(mo.Data,t),l=new mo.TMap(h,{width:a.width,height:a.height}),c=l.getNode();a.addChild(c),this.map=l;var p=new eui.Group;c.addChild(p),p.name="MapTouchController",p.width=3*c.width,p.height=3*c.height,p.anchorOffsetX=p.width/2,p.anchorOffsetY=p.height/2,this.buildSubMap(e,a);var u=l.cell2world(0,0);this.updateMapPosition(u[0],u[1]);var d=0,g=0,f=!1;p.touchEnabled=!0,p.addEventListener(egret.TouchEvent.TOUCH_BEGIN,o,this),p.addEventListener(egret.TouchEvent.TOUCH_END,n,this)},e.prototype.getLineInsertPoint=function(t,e){var i=(t.b-e.b)/(e.k-t.k),o=e.k*i+e.b;return[i,o]},e.prototype.getBorderCorner=function(t,e){var i,o,n=Math.abs(e.width/2),r=Math.abs(n*t.lt.k),s={x:n,y:r},a=Math.abs(e.height/2),h=Math.abs(a/t.rb.k),l={x:h,y:a},c=[];return p=this.getLineInsertPoint(t.lt,t.rt),i=p[0],o=p[1],c[0]=[i-s.x,o+s.y],u=this.getLineInsertPoint(t.lt,t.lb),i=u[0],o=u[1],c[1]=[i+l.x,o-l.y],d=this.getLineInsertPoint(t.lb,t.rb),i=d[0],o=d[1],c[2]=[i-s.x,o-s.y-e.height],g=this.getLineInsertPoint(t.rt,t.rb),i=g[0],o=g[1],c[3]=[i-l.x-e.width,o-l.y],c;var p,u,d,g},e.prototype.getLineFormulas=function(t,e){void 0===e&&(e=2);var i={lt:null,rt:null,lb:null,rb:null},o=[t.getInfo().cols-1,t.getInfo().rows-1],n=o[0],r=o[1],s=t.cell2world(0,0),a=t.cell2world(0,r),h=t.cell2world(n,0),l=t.cell2world(n,r),c=t.cell2world(-e,0),p=t.cell2world(0,-e),u=t.cell2world(0,r+e),d=t.cell2world(n+e,0),g={lt:[s,a,c],rt:[s,h,p],lb:[a,l,u],rb:[h,l,d]};for(var f in g){var y=g[f],v=y[0],m=y[1],_=y[2],w=(v[1]-m[1])/(v[0]-m[0]),M=_[1]-w*_[0];i[f]={k:w,b:M}}return i},e.prototype.getCameraRange=function(t,e){var i=this,o=this.formulas,n=this.border,r=[t,e],s=r[0],a=r[1],h=s*o.lt.k+o.lt.b,l=[t+i.width,e],c=l[0],p=l[1],u=c*o.rt.k+o.rt.b,d=[t,e+i.height],g=d[0],f=d[1],y=g*o.lb.k+o.lb.b,v=[t+i.width,e+i.height],m=v[0],_=v[1],w=m*o.rb.k+o.rb.b,M=[a>h,p>u,y>f,w>_],C=M[0],E=M[1],T=M[2],x=M[3];if(C&&E&&T&&x)return[t,e];if(!C&&!E)return n[0];if(!T&&!x)return n[2];if(C)if(E)if(T){if(!x){var I=[t+i.width,w-i.height],b=I[0],S=I[1],L=b*o.rt.k+o.rt.b;S>L?e=S:(z=n[3],t=z[0],e=z[1])}}else{var A=[t,y-i.height],R=A[0],B=A[1],P=R*o.lt.k+o.lt.b;B>P?e=B:(X=n[1],t=X[0],e=X[1])}else{var D=[t+i.width,u+i.height],k=D[0],N=D[1],V=k*o.rb.k+o.rb.b;V>N?e=u:(Y=n[3],t=Y[0],e=Y[1])}else{var O=[t,h+i.height],U=O[0],F=O[1],G=U*o.lb.k+o.lb.b;G>F?e=h:(H=n[1],t=H[0],e=H[1])}return[t,e];var H,Y,X,z},e.prototype.buildSubMap=function(t,e){for(var i=0,o=t;i<o.length;i++){var n=o[i],r=new mo.Data(n),s=new mo.TMap(r,{width:e.width,height:e.height}),a=s.getNode();e.addChildAt(a,0),this.subMaps.push(s)}},e.prototype.updateMapPosition=function(t,e){this.map.setPos(t,e),this.subMaps.map(function(i){return i.setPos(t,e)}),this.scrollCallback&&this.scrollCallback(t,e)},e.prototype.moveToMapPosition=function(t,e,i,o){var n=this;egret.Tween.removeTweens(this.map),egret.Tween.get(this.map).wait(0).to({x:t,y:e},i).call(function(){o&&o(),n.scrollCallback&&n.scrollCallback(t,e)}),this.subMaps.map(function(o){egret.Tween.removeTweens(o),egret.Tween.get(o).wait(0).to({x:t,y:e},i)})},e}(eui.Group);__reflect(MapScroller.prototype,"MapScroller");var RoleVO=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(PlayerVO);__reflect(RoleVO.prototype,"RoleVO");var world;!function(t){function e(t){var e=t-1;return e*e*e+1}var i=4,o=[1,1.33,1.66,2],n=2.33,r=.02,s=.998,a=Math.log(s),h=function(){function t(t,i,o){this.$scrollFactor=1,this.previousTime=0,this.velocity=0,this.previousVelocity=[],this.currentPosition=0,this.previousPosition=0,this.currentScrollPos=0,this.maxScrollPos=0,this.offsetPoint=0,this.$bounces=!0,this.started=!0,this.updateFunction=t,this.endFunction=i,this.target=o,this.animation=new eui.sys.Animation(this.onScrollingUpdate,this),this.animation.endFunction=this.finishScrolling,this.animation.easerFunction=e}return t.prototype.isPlaying=function(){return this.animation.isPlaying},t.prototype.stop=function(){this.animation.stop(),egret.stopTick(this.onTick,this),this.started=!1},t.prototype.isStarted=function(){return this.started},t.prototype.start=function(t){this.started=!0,this.velocity=0,this.previousVelocity.length=0,this.previousTime=egret.getTimer(),this.previousPosition=this.currentPosition=t,this.offsetPoint=t,egret.startTick(this.onTick,this)},t.prototype.update=function(t,e,i){e=Math.max(e,0),this.currentPosition=t,this.maxScrollPos=e;var o=this.offsetPoint-t,n=o+i;this.offsetPoint=t,n-=.5*o,this.currentScrollPos=n,this.updateFunction.call(this.target,n)},t.prototype.finish=function(t,e){egret.stopTick(this.onTick,this),this.started=!1;for(var i=this.velocity*n,s=this.previousVelocity,h=s.length,l=n,c=0;h>c;c++){var p=o[c];i+=s[0]*p,l+=p}var u=i/l,d=Math.abs(u),g=0,f=0;d>r?(f=t+(u-r)/a*2*this.$scrollFactor,g=Math.log(r/d)/a):f=t,g>0?this.throwTo(f,g):this.finishScrolling()},t.prototype.onTick=function(t){var e=t-this.previousTime;if(e>10){var o=this.previousVelocity;o.length>=i&&o.shift(),this.velocity=(this.currentPosition-this.previousPosition)/e,o.push(this.velocity),this.previousTime=t,this.previousPosition=this.currentPosition}return!0},t.prototype.finishScrolling=function(t){var e=this.currentScrollPos,i=(this.maxScrollPos,e);this.throwTo(i,300)},t.prototype.throwTo=function(t,e){void 0===e&&(e=500);var i=this.currentScrollPos;if(i==t)return void this.endFunction.call(this.target);var o=this.animation;o.duration=e,o.from=i,o.to=t,o.play()},t.prototype.onScrollingUpdate=function(t){this.currentScrollPos=t.currentValue,this.updateFunction.call(this.target,t.currentValue)},t}();t.TouchScroll=h,__reflect(h.prototype,"world.TouchScroll")}(world||(world={}));var config;!function(t){t.MAP_URLS=["ditu_json"],t.MAP_CONFIG="dresource/Config/Map/",t.MAP_BORDER_OFFSET=4,t.MAP_UPDATE_COLS=30,t.MAP_UPDATE_ROWS=30,t.MAP_BLOCKED_LAYER_NAME="zudang"}(config||(config={}));var Fight;!function(t){var e=function(){function e(){this.roleViews={},this.fightIndex=0}return e.prototype.startFinght=function(){this.timer=new egret.Timer(600,0),this.timer.addEventListener(egret.TimerEvent.TIMER,this.excuteFight,this),this.timer.start()},e.prototype.excuteFight=function(){if(console.log(this.fightData.length),this.fightIndex>=this.fightData.length-1)console.log(" 战斗完毕 == "),this.timer.stop(),Prompt.popTip("模拟战报战斗结束");else{var t=this.fightData[this.fightIndex],e=this.roleViews[t.attacker_id];e.atttack(t.attack_info_list),console.log(" key == "+t.attacker_id),this.fightIndex++}},e.prototype.embattleCallBack=function(t,e){console.log(" 布阵士兵到达位置回调 == "+t.getAcDirIndex()),t.setAcDirIndex(e),console.log(t.getVO().getId()+"= 布阵士兵到达位置回调22 == "+t.getAcDirIndex()),t.playAction()},e.prototype.goToTargetCallBack=function(){var e=this,i=this.startArmyViews.getMainViews(),o=(i.getVO(),i.getAcDirIndex());switch(console.log("我是行走结束回调....开始布阵 = "+o),o){case 0:case 4:break;case 1:case 5:break;case 2:case 6:for(var n=i,r=this.startArmyViews.getNextRoleView(n),s=-1,a=i.getVO().getCellXY(),h=a[0],l=a[1];r;){var c=h+s,p=l+s;s=1,n=r,n.disFrontRoleView(),n._moveOnePath(c,p,function(t){e.embattleCallBack(t,o)}),r=this.startArmyViews.getNextRoleView(n)}break;case 3:case 7:}var u=this.targetArmyViews.getSelectView(),d=0;d=o>=4?o-4:o+4,u.disFrontRoleView(),u.setAcDirIndex(d),u.playAction();var g=this.targetArmyViews.getOtherRoleView(u),f=u.getVO().getCellXY(),y=f[0],v=f[1],m=-1;for(var _ in g){var c=y+m,p=v+m;m=1;var n=g[_];n.disFrontRoleView(),n._moveOnePath(c,p,function(t){e.embattleCallBack(t,d)})}var w=new t.FightTest;this.fightData=w.calculateFightData(this.startArmyViews,this.targetArmyViews),egret.setTimeout(function(){this.startFinght()},this,3e3)},e.prototype.goToTarget=function(t,e){var i=this;this.startArmyViews=t,this.targetArmyViews=e,utils.mergeObject(this.startArmyViews.getRoleViews(),this.roleViews),utils.mergeObject(this.targetArmyViews.getRoleViews(),this.roleViews);var o=this.findNearCell(t,e),n=t.getMainViews(),r=this.findRoundNearCell(n,o),s=r[0],a=r[1];n._moveOnePath(s,a,function(){return i.goToTargetCallBack()})},e.prototype.findRoundNearCell=function(t,e){for(var i,o,n=t.vo.getCellXY(),r=n[0],s=n[1],a=e.vo.getCellXY(),h=a[0],l=a[1],c=h-1,p=h+1,u=l-1,d=l+1,g=void 0,f=c;p>=f;f++)for(var y=u;d>=y;y++)if(void 0!==g){var v=this.disTowPoint(r,s,f,y);g>v&&(g=v,i=f,o=y)}else g=this.disTowPoint(r,s,f,y),i=f,o=y;return[i,o]},e.prototype.findNearCell=function(t,e){var i,o=t.getMainViews(),n=e.getRoleViews();for(var r in n){var s=n[r];if(i){var a=this.disTowView(o,i),h=this.disTowView(o,s);a>h&&(i=s)}else i=s}return e.setSelectView(i),i},e.prototype.disTowView=function(t,e){var i=this.disTowPoint(t.vo.getX(),t.vo.getY(),e.vo.getX(),e.vo.getY());return i},e.prototype.disTowPoint=function(t,e,i,o){var n=Math.abs(t-i),r=Math.abs(e-o),s=Math.sqrt(n*n+r*r);return s},e.prototype.addWar=function(t){},e.prototype.outWar=function(){},e}();t.FightMgr=e,__reflect(e.prototype,"Fight.FightMgr")}(Fight||(Fight={}));var Fight;!function(t){var e=function(){function t(){this.fightData=[],this.roundIndex=0}return t.prototype.calculateFightData=function(t,e){var i=t.getRoleViews(),o=e.getRoleViews();for(var n in i)for(var r in o)i[n].vo.getCellX()+1!=o[r].vo.getCellX()||i[n].vo.getCellY()-1!=o[r].vo.getCellY()||(i[n].setAttackView(o[r]),o[r].setAttackView(i[n]),console.log("一对.............."));for(var s=0,a=i;!this.meAttackOther(a,s);)s++,a=s%2==0?i:o;return this.fightData},t.prototype.meAttackOther=function(t,e){var i=!0;for(var o in t){var n=t[o];if(n.getAttackView().getVO_temp().getCurHp()<=0)console.log("(攻击或被击)该单位阵亡................. id ="+n.getAttackView().getVO_temp().getId());else{i=!1;var r={};console.log(n.getVO().getId()+" 击打了 "+n.getAttackView().getVO().getId()),r.attacker_id=o,r.attacker_type=0,r.attacker_hp=n.vo.getCurHp(),r.skill_id=0,r.attacker_x=n.vo.getX(),r.attacker_y=n.vo.getY();var s={};s.defender_id=n.getAttackView().getVO().getId();var a={};a.damage=Math.floor(Math.random()*(e%2==0?500:200)),a.defender_hp=n.getAttackView().getVO_temp().getCurHp()-a.damage,n.getAttackView().getVO_temp().setCurHp(a.defender_hp),s.damage_info_list=a,r.attack_info_list=s,this.fightData[this.roundIndex]=r,this.roundIndex++}}return i},t}();t.FightTest=e,__reflect(e.prototype,"Fight.FightTest")}(Fight||(Fight={}));var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var logic;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.data=[],e}return __extends(e,t),e.prototype.setData=function(t){this.data=t},e.prototype.getInfo=function(t){var e=this.data.filter(function(e){return e.build_id===t});return e[0]},e.prototype.getAllArmyInfo=function(){return this.data.reduce(function(t,e){return t.concat(e.army_list)},[])},e.prototype.getMainBuildPos=function(){var t=this.data[0]||{};return{x:t.x||0,y:t.y||0}},e.prototype.getBuildIdByArmyId=function(t){for(var e=0,i=this.data;e<i.length;e++)for(var o=i[e],n=0,r=o.army_list;n<r.length;n++){var s=r[n];if(s.army_id===t)return o.build_id}},e.prototype.isBuildMenu=function(t){return t.info&&t.info.type>0?!0:!1},e.prototype.getConfig=function(t){var e=RES.getRes("BuildingLevelConfig_json");for(var i in e)if(e[i].type===t)return e[i];return null},e}(Logic);t.Build=e,__reflect(e.prototype,"logic.Build")}(logic||(logic={}));var LogicMgr;!function(t){function e(t){if(o.has(t))return o.get(t);var e=new t;return o.set(t,e),e}function i(){for(var t,e=this.singleton.values()[Symbol.iterator]();!(t=e.next()).done;)t.value.dispose()}var o=new Map;t.get=e,t.disposeAll=i}(LogicMgr||(LogicMgr={}));var INTERVAL=100,OUTTIME=1e3,WAITTIME=5e3,NET_HEART="NET_HEART",NET_WAITING="NET_WAITING",NetCenter=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.host="",e.port=8e3,e.sendQueue=[],e.order=0,e.state="disconnect",e.waitTime=0,e.isBusy=!1,e}return __extends(e,t),e.prototype.connectServer=function(t,e){i=[t||this.host,e||this.port],this.host=i[0],this.port=i[1],this.doClose(),this.doConnect();var i},e.prototype.diconnectServer=function(){this.doClose()},e.prototype.sendMessage=function(t,e){return this.sendQueue.push({mainId:t,buff:e}),this.isState("disconnect")?this.doConnect():void 0},e.prototype.doClose=function(){console.log("doClose"),this.sock&&(this.sock.close(),this.sock=null),Singleton(Timer).cancel(this,NET_HEART),Singleton(Timer).cancel(this,NET_WAITING),this.sendQueue=[],this.waitTime=0,this.order=0},e.prototype.doReConnect=function(){this.doClose(),this.doConnect()},e.prototype.doConnect=function(){""!==this.host&&(this.sock=new egret.WebSocket,this.sock.type="webSocketTypeBinary",this.sock.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this),this.sock.addEventListener(egret.Event.CONNECT,this.onSocketOpen,this),this.sock.addEventListener(egret.Event.CLOSE,this.onSocketClose,this),this.sock.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onSocketError,this),this.sock.connect(this.host,this.port),this.isBusy=!1,this.toState("connecting"))},e.prototype.startTimer=function(){Singleton(Timer).repeat(INTERVAL,this.Event(NET_HEART,this.onHeartBeat)),Singleton(Timer).repeat(OUTTIME,this.Event(NET_WAITING,this.onWaiting))},e.prototype.sendNext=function(){if(0!==this.sendQueue.length&&this.isState("ready")){this.order++;var t=this.sendQueue.shift();this.doSendMessage(t.mainId,t.buff)}},e.prototype.onSocketClose=function(){console.log("onSocketClose"),this.toState("disconnect"),this.fireEvent(e.EVT.CLOSE)},e.prototype.onSocketError=function(){console.log("onSocketError"),this.doClose(),this.fireEvent(e.EVT.ERROR)},e.prototype.onSocketOpen=function(){console.log("onSocketOpen"),this.startTimer(),this.toState("ready"),this.fireEvent(e.EVT.CONN),this.sendNext()},e.prototype.onHeartBeat=function(){this.sendNext()},e.prototype.onWaiting=function(t){return this.isState("waiting")?(this.waitTime+=OUTTIME,this.waitTime>WAITTIME?this.doReConnect():void 0):void(this.waitTime=0)},e.prototype.onReceiveMessage=function(){this.doReceiveMessage(),this.sendNext()},e.prototype.doReceiveMessage=function(){this.toState("ready");var t=new egret.ByteArray;this.sock.readBytes(t);var e=t.readShort(),i=new egret.ByteArray;t.readBytes(i);var o=NetMgr.getMsgCls(e);if(!o)throw new Error("Net Receiver Error: "+e);NetMgr.get(o).onRecv(e,i.buffer)},e.prototype.doSendMessage=function(t,e){this.toState("waiting");var i=new egret.ByteArray;i.writeShort(t),i.writeBytes(new egret.ByteArray(e)),this.sock.writeBytes(i)},e.prototype.updateBusyState=function(){var t=!1;this.isState("connecting")?t=!0:this.isState("waiting")&&(t=!0),this.isBusy!==t&&(this.isBusy=t,this.fireEvent(e.EVT.BUSY,this.isBusy))},e.prototype.toState=function(t){this.state=t,this.updateBusyState()},e.prototype.isState=function(t){return this.state===t},e}(Logic);NetCenter.EVT=utils.Enum(["CONN","ERROR","BUSY","CLOSE"]),__reflect(NetCenter.prototype,"NetCenter");var NetMgr;!function(t){function e(t){if(r.has(t))return r.get(t);var e=new t;return r.set(t,e),e}function i(){for(var t,e=this.singleton.values()[Symbol.iterator]();!(t=e.next()).done;)t.value.dispose()}function o(t){var e=Math.floor(t/100);return s.get(e)}function n(){console.log("NetMgr init ..................");for(var e=Object.getOwnPropertyNames(msg),i=0,o=e;i<o.length;i++){var n=o[i],r=t.get(msg[n]);r.init(Singleton(NetCenter)),s.set(r.getModId(),msg[n])}}var r=new Map;t.get=e,t.disposeAll=i;var s=new Map;t.getMsgCls=o,t.init=n}(NetMgr||(NetMgr={}));var logic;!function(t){var e=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.setSoldierIds=function(t){this.mSoldierIds=t},e}(Logic);e.EVT=utils.Enum(["SOLDIER_TOUCH_MOVE","SOLDIER_TOUCH_BEGIN","SOLDIER_TOUCH_END"]),t.Camp=e,__reflect(e.prototype,"logic.Camp")}(logic||(logic={}));var Prompt;!function(t){function e(t){var e="tipsEffect",i=UIMgr.getLayer("effect"),o=new egret.TextField;try{o.textFlow=(new egret.HtmlTextParser).parser(t)}catch(n){o.text=t}var r=i.getChildByName(e);i.getChildByName(e)||(r=new egret.DisplayObjectContainer,i.addChild(r),r.name=e);for(var s=function(t){var e=r.getChildAt(t);egret.Tween.get(e,{onChange:function(){return e.y-=1}}).wait(300)},a=0;a<r.numChildren;a++)s(a);o.anchorOffsetX=o.width/2,o.anchorOffsetY=o.height/2,o.x=i.width/2,o.y=i.height/2,r.addChild(o),egret.Tween.get(o).to({scaleX:1.2,scaleY:1.2},200).to({scaleX:1,scaleY:1},100).call(function(){egret.Tween.get(o,{onChange:function(){return o.y-=1}}).to({alpha:0},1500)}).wait(1500).call(function(){r.removeChild(o)})}t.popTip=e}(Prompt||(Prompt={}));var SeverTime;!function(t){function e(t){n=egret.getTimer()-t}function i(){return egret.getTimer()+n}function o(t){if(!t)return{day:0,hour:0,min:0,sec:0};var e={day:Math.floor(t/86400),hour:Math.floor(t%86400/3600),min:Math.floor(t%3600/60),sec:t%60};return e}var n=0;t.setTime=e,t.getTime=i,t.secToDay=o}(SeverTime||(SeverTime={}));var Timer=function(){function t(){this.events=[]}return t.prototype.dispose=function(){console.assert(0===this.events.length)},t.prototype.unbind=function(t,e){for(var i=0;i<this.events.length;i++)if(this.events[i].event===t)return void this.events.splice(i,1)},t.prototype.cancel=function(t,e){t.EventTracer().cancel(e)},t.prototype.process=function(){for(var t=egret.getTimer();this.events[0]&&this.events[0].clock<=t;){var e=this.events[0],i=t-e.lastClock;this.events.splice(0,1),this.queue(e),1===e.times&&e.event.unbind(),0!==e.times&&(e.times=e.times-1),e.event.fire(i)}},t.prototype.after=function(t,e){return this.repeat(t,e,1)},t.prototype.repeat=function(t,e,i){void 0===i&&(i=0);var o={event:e,interval:t,times:i,clock:0,lastClock:0};return e.bind(this),this.queue(o),e},t.prototype.queue=function(t){t.lastClock=egret.getTimer(),t.clock=t.lastClock+t.interval;for(var e=0,i=0;i<this.events.length&&!(this.events[i].clock>t.clock);i++)e=i+1;this.events.splice(e,0,t)},t}();__reflect(Timer.prototype,"Timer",["events.EventHandle"]);var mo;!function(t){var e=function(){function e(e,i){this.dataSource=e,this.data=e.getResult(),this.rootNode=new eui.Group,this.rootNode.width=this.data.info.w,this.rootNode.height=this.data.info.h,this.rootNode.addEventListener(egret.Event.ENTER_FRAME,this.update,this),this.coordinate=new t.Coordinate(this.data.info),this.camera=new t.Camera(this,i),this.layers=new t.Layers(this,this.camera,this.data)}return e.prototype.dispose=function(){this.rootNode.removeEventListener(egret.Event.ENTER_FRAME,this.update,this),this.layers.dispose(),this.camera.dispose(),this.layers=null,this.camera=null,this.updateCallback=null,this.tapCallback=null},e.prototype.world2cell=function(t,e){return this.coordinate.world2cell(t,e)},e.prototype.cell2world=function(t,e){return this.coordinate.cell2world(t,e)},e.prototype.cell2index=function(t,e){return this.coordinate.cell2index(t,e)},e.prototype.index2cell=function(t){return this.coordinate.index2cell(t)},Object.defineProperty(e.prototype,"x",{get:function(){return this.camera.x},set:function(t){this.camera.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.camera.y},set:function(t){this.camera.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.rootNode.width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.rootNode.height},enumerable:!0,configurable:!0}),e.createCoordinate=function(e){var i={x:e.tilewidth/2*((e.width+1)%2),y:0},o={rows:e.height,cols:e.width,ox:i.x+e.tilewidth*e.width/2+(e.ox||0),oy:i.y+e.tileheight/2+(e.oy||0),cw:e.tilewidth,ch:e.tileheight,w:e.width*e.tilewidth,h:e.height*e.tileheight};return new t.Coordinate(o)},e.prototype.createCoordinate=function(t,i,o){void 0===i&&(i=0),void 0===o&&(o=0);var n={};return t=Math.floor(t),n.tilewidth=this.data.info.cw/t,n.tileheight=this.data.info.ch/t,n.height=n.width=t,n.ox=i,n.oy=o,e.createCoordinate(n)},e.prototype.getNode=function(){return this.rootNode},e.prototype.setViewSize=function(t){this.camera.setViewSize(t)},e.prototype.getViewSize=function(){return this.camera.getViewSize()},e.prototype.setPos=function(t,e){this.camera.setPos(t,e)},e.prototype.getPos=function(){return this.camera.getPos()},e.prototype.getCenterCPos=function(){var t=this.getCenterWPos();return this.world2cell(t[0],t[1])},e.prototype.getCenterWPos=function(){var t=this.camera.getViewSize(),e=this.camera.getPos();return e=[e[0]+t.width/2,e[1]+t.height/2]},e.prototype.update=function(){if(this.camera.update()){var t=this.camera.getPos(),e=t[0],i=t[1];this.layers.viewportChanged(e,i)}},e.prototype.getInfo=function(){return this.data.info},e.prototype.getData=function(){return this.dataSource},e.prototype.registTapCallback=function(t){this.tapCallback=t},e.prototype.registUpdateCallback=function(t,e){void 0===e&&(e="default"),this.updateCallback=this.updateCallback||{},this.updateCallback[e]=t},e.prototype.callUpdateCallback=function(t,e){this.updateCallback&&this.updateCallback[e]&&this.updateCallback[e](t)},e.prototype.callUpdateCallbackByDefault=function(t){this.callUpdateCallback(t,"default")},e.prototype.touchTap=function(t){if(this.tapCallback){var e=this.rootNode.globalToLocal(t.stageX,t.stageY);this.tapCallback(e)}},e.getMainData=function(){return Singleton(t.Data,config.MAP_URLS[0])},e.prototype.callNextFrame=function(t,e){this.canelNextFrame(),this.timer=utils.after(0,t,e)},e.prototype.canelNextFrame=function(){this.timer&&(this.timer.stop(),this.timer=null)},e}();t.TMap=e,__reflect(e.prototype,"mo.TMap")}(mo||(mo={}));var mo;!function(t){var e=function(){function t(t,e){this.map=t,this.viewSize=e,this.node=t.getNode(),this.lastPos={x:1/0,y:1/0}}return t.prototype.dispose=function(){},t.prototype.setPos=function(t,e){i=[-t,-e],this.node.x=i[0],this.node.y=i[1];var i},t.prototype.getPos=function(){return[-this.node.x,-this.node.y]},t.prototype.getViewSize=function(){return this.viewSize},t.prototype.setViewSize=function(t){this.viewSize=t},Object.defineProperty(t.prototype,"x",{get:function(){return-this.node.x},set:function(t){this.node.x=-t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return-this.node.y},set:function(t){this.node.y=-t},enumerable:!0,configurable:!0}),t.prototype.update=function(){var t=[this.node.x,this.node.y],e=t[0],i=t[1];return e===this.lastPos.x&&i===this.lastPos.y?!1:(this.lastPos.x,this.lastPos.y=e,i,!0)},t}();t.Camera=e,__reflect(e.prototype,"mo.Camera")}(mo||(mo={}));var mo;!function(t){var e=function(){function t(t){this.info=t}return t.prototype.getInfo=function(){return this.info},t.prototype.cell2world=function(t,e){var i=this.info.ox+(t-e)*this.info.cw/2,o=this.info.oy+(t+e)*this.info.ch/2;return this.info.cols%2===0&&(i-=this.info.cw/2),[i,o]},t.prototype.world2cell=function(t,e){this.info.cols%2===0&&(t+=this.info.cw/2),t-=this.info.ox,e-=this.info.oy;var i=Math.floor(e/this.info.ch+t/this.info.cw+.5),o=Math.floor(e/this.info.ch-t/this.info.cw+.5);return[i,o]},t.prototype.index2cell=function(t,e){var i=t%(e||this.info.cols),o=Math.floor(t/this.info.cols);return[i,o]},t.prototype.cell2index=function(t,e,i){return e*(i||this.info.cols)+t},t}();t.Coordinate=e,__reflect(e.prototype,"mo.Coordinate")}(mo||(mo={}));var mo;!function(t){var e=function(){function e(e){this.data=RES.getRes(e),this.info=this.getInfo(),this.cellDatas={},this.loadingList={},this.coordinate=new t.Coordinate(this.info),this.loadTilesets(),this.loadLayers()}return e.prototype.getResult=function(){return{info:this.info,layers:this.layers,tilesets:this.tilesets,bgInfo:{url:"resource/assets/Map/zwsy.png",size:{w:256,h:256}}}},e.prototype.getInfo=function(){var t={x:this.data.tilewidth/2*((this.data.width+1)%2),y:0},e={offset:t,rows:this.data.height,cols:this.data.width,ox:t.x+this.data.tilewidth*this.data.width/2,oy:t.y+this.data.tileheight/2,cw:this.data.tilewidth,ch:this.data.tileheight,w:this.data.width*this.data.tilewidth,h:this.data.height*this.data.tileheight};return e},e.prototype.getTile=function(t,e,i,o,n){var r=t.tileoffset||{},s=r.x||0,a=r.y||0,h=(t.spacing||0,{x:n.x+(t.tilewidth+t.spacing)*i,y:n.y+(t.tileheight+t.spacing)*o,width:t.tilewidth,height:t.tileheight}),l={image:t.image,rect:h,offsetX:s,offsetY:a};return l},e.prototype.loadTilesets=function(){for(var t={offsets:{},tiles:{}},e=0,i=this.data.tilesets;e<i.length;e++){var o=i[e],n=[o.imagewidth,o.imageheight],r=n[0],s=n[1],a={x:0,y:0};o.margin&&(g=[r-2*o.margin,s-2*o.margin],r=g[0],s=g[1],a.x+=o.margin,a.y+=o.margin);for(var h=o.columns||1,l=Math.ceil(o.tilecount/h),c=0;l>c;c++)for(var p=0;h>p;p++){var u=h*c+p;if(!(u>=o.tilecount)){var d=o.firstgid+u;t.tiles[d]=this.getTile(o,u,p,c,a)}}}this.tilesets=t;var g},e.prototype.getResSubIdxByIndex=function(t){var e=this.coordinate.index2cell(t),i=e[0],o=e[1],n=Math.floor(i/this.data.clipRange),r=Math.floor(o/this.data.clipRange),s=Math.ceil(this.data.width/this.data.clipRange),a=this.coordinate.cell2index(n,r,s);return a=Math.min(this.data.subFiles.length-1,a),a=Math.max(0,a)},e.prototype.getResFullPath=function(t){return""+config.MAP_CONFIG+t},e.prototype.getResFullPathBySubIdx=function(t){var e=this.data.subFiles[t];return""===e?null:this.getResFullPath(e)},e.prototype.setCellDataBySubIdx=function(t,e){this.cellDatas[t]=e},e.prototype.getCellDataBySubIdx=function(t){return this.cellDatas[t]},e.prototype.getCellDataByIndex=function(t){var e=this.getResSubIdxByIndex(t);return this.getCellDataBySubIdx(e)},e.prototype.loadAllDataFiles=function(t,e){var i=this,o=Object.keys(t),n=o.map(function(t){return i.loadDataFile(parseInt(t))});Promise.all(n).then(e,e)},e.prototype.loadDataFile=function(t){var e=this;return new Promise(function(i){var o=e.cellDatas[t];if(o)return i(o);var n=function(o){e.setCellDataBySubIdx(t,o),i(o)};e.loadingList[t]=e.loadingList[t]||[];var r=e.loadingList[t].length>0;if(e.loadingList[t].push(n),!r){var s=e.getResFullPathBySubIdx(t);RES.getResByUrl(s,function(i){for(var o=0,n=e.loadingList[t];o<n.length;o++){var r=n[o];r(i)}e.loadingList[t]=[]},e,"json")}})},e.prototype.getCellTileByName=function(t,e){var i=this.coordinate.cell2index(t.x,t.y),o=this.layers.indexOf(e);return 0>o?void 0:this.getCellTile(i,o)},e.prototype.getCellTile=function(t,e){var i=this.getCellDataByIndex(t);if(i&&i[e]){var o=i[e][t];if(o&&0!==o)return this.tilesets.tiles[o]}},e.prototype.loadLayers=function(){this.layers=[];for(var t=0,e=this.data.layers;t<e.length;t++){var i=e[t],o=i.name;this.layers.push(o)}},e.prototype.isBlocked=function(t,e){return!1},e}();t.Data=e,__reflect(e.prototype,"mo.Data")}(mo||(mo={}));var mo;!function(t){var e=function(){function t(t){this.map=t,this.cells={},this.keyCache=[],this.cellFiles={},this.isUpdate=!1,this.pos={x:1/0,y:1/0}}return t.prototype.isNeedUpdate=function(){return this.isUpdate},t.prototype.update=function(t,e){var i=this.map.getViewSize(),o=this.pos.x,n=this.pos.y;if(Math.abs(t-o)<.5*i.width&&Math.abs(e-n)<.5*i.height)return this.isUpdate=!1,this.keyCache=[],void(this.cellFiles={});this.isUpdate=!0,r=[t,e],this.pos.x=r[0],this.pos.y=r[1],this.cells=this.updateCells(t,e);var r},t.prototype.getCells=function(){return this.cells},t.prototype.getCellsKey=function(){return this.keyCache},t.prototype.getCellFiles=function(){return this.cellFiles},t.prototype.updateCells=function(t,e){var i=this.map.getViewSize(),o=t-.5*i.width,n=e-.5*i.height,r=t+1.5*i.width,s=e+1.5*i.height,a=this.map.world2cell(o,n),h=a[0],l=a[1],c=this.map.world2cell(r,s),p=c[0],u=c[1],d=this.map.world2cell(r,n),g=d[0],f=d[1],y=this.map.world2cell(o,s),v=y[0],m=y[1],_=this.map.getInfo(),w=Math.max(0,Math.min(h,p,g,v)),M=Math.min(_.rows-1,Math.max(h,p,g,v)),C=Math.max(0,Math.min(l,u,f,m)),E=Math.min(_.cols-1,Math.max(l,u,f,m));this.keyCache=[];for(var T={},x=w;M>=x;x++)for(var I=C;E>=I;I++){var b=this.map.cell2index(x,I);T[b]=b,this.keyCache.push(b);var S=this.map.getData().getResSubIdxByIndex(b);this.cellFiles[S]||(this.cellFiles[S]=S)}return T},t}();t.DynamicCells=e,__reflect(e.prototype,"mo.DynamicCells")}(mo||(mo={}));var logic;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.actions=new Array,e}return __extends(e,t),e.prototype.createGuideById=function(t){for(var e=RES.getRes("GuideMotherConfig_json"),o=e[t],n=0;n<o.length;n++){var r=o[n],s=r.isBottom,a=r.layer,h=r.btn,l=new i;l.setBtn(h),l.setIsBottom(s),l.setUi(ui),l.setLayer(a),this.actions.push(l)}this.runGuideAction()},e.prototype.runGuideAction=function(){if(this.actions&&!(this.actions.length<=0)){var t=this.actions[0];t.run()}},e.prototype.finishAction=function(){this.actions.shift(),this.actions&&0===this.actions.length||this.runGuideAction()},e}(Logic);e.EVT=utils.Enum(["ACTION_FINISHED"]),t.Guide=e,__reflect(e.prototype,"logic.Guide");var i=function(){function t(){}return t.prototype.setBtn=function(t){this.btn=t},t.prototype.setUi=function(t){this.ui=t},t.prototype.setIsBottom=function(t){this.isBottom=t},t.prototype.setLayer=function(t){this.layer=t},t.prototype.run=function(){var t=null;if("home"===this.layer)t=UIMgr.getHome();else if("world"===this.layer)t=UIMgr.getWorld();else{var e=UIMgr.getLayer("panel");t=e.getChildAt(e.numChildren-1)}UIMgr.getGuide().createGuidePanel(t[this.btn],this.isBottom)},t}();__reflect(i.prototype,"GuideAction")}(logic||(logic={}));var logic;!function(t){var e=function(e){function i(){var i=e.call(this)||this;return LogicMgr.get(t.Login).on(t.Login.EVT.START,i.Event("onLogic")),i
}return __extends(i,e),i.prototype.onLogic=function(t,e){console.log("onLogic Home",t,e)},i}(Logic);t.Home=e,__reflect(e.prototype,"logic.Home")}(logic||(logic={}));var logic;!function(t){var e=function(e){function i(){var t=e.call(this)||this;return t.totalMessages=3,NetMgr.get(msg.Login).on("m_login_auth_toc",t.Event("onLogin")),NetMgr.get(msg.Login).on("m_login_create_role_toc",t.Event("onCreateRole")),NetMgr.get(msg.Login).on("m_login_get_role_detail_toc",t.Event("onGetRoleDetail")),NetMgr.get(msg.Build).on("m_build_get_build_list_toc",t.Event("onGetBuildGuildList")),NetMgr.get(msg.Army).on("m_army_get_own_soldier_toc",t.Event("onGetOwnSoldiers")),t.finishedMessages=0,t.serverListInfo=RES.getRes("serverList_json"),t.curServerInfo=t.serverListInfo[0],t}return __extends(i,e),i.prototype.onLogin=function(e){return console.log("onNetMsg",e),1===e.ret_code?0!==e.login_info.length?(LogicMgr.get(t.Player).setRoleId(e.login_info[0].role_id),LogicMgr.get(t.Player).setRoleName(e.login_info[0].nick),LogicMgr.get(t.Player).setRoleLevel(e.login_info[0].lv),this.getRoleDetailInfo(),this.getBuildGuildList(),void this.getOwnSoldiers()):void this.fireEvent(t.Login.EVT.REGISTER_ROLE):void 0},i.prototype.getRoleDetailInfo=function(){var e=LogicMgr.get(t.Player).getRoleId(),i={role_id:e};NetMgr.get(msg.Login).send("m_login_get_role_detail_tos",i)},i.prototype.getBuildGuildList=function(){NetMgr.get(msg.Build).send("m_build_get_build_list_tos")},i.prototype.getOwnSoldiers=function(){NetMgr.get(msg.Army).send("m_army_get_own_soldier_tos")},i.prototype.onCreateRole=function(e){console.log("onCreateRole = %d",e.ret_code),1===e.ret_code&&(LogicMgr.get(t.Player).setRoleId(e.role_id),this.getRoleDetailInfo(),this.getBuildGuildList(),this.getOwnSoldiers())},i.prototype.onGetRoleDetail=function(e){console.log("onGetRoleDetail = %d",e.ret_code),1===e.ret_code&&(LogicMgr.get(t.Player).setRoleId(e.role_info.role_id),LogicMgr.get(t.Player).setRoleName(e.role_info.nick),LogicMgr.get(t.Player).setRoleLevel(e.role_info.lv),LogicMgr.get(t.Player).setRoleExp(e.role_info.cur_exp),LogicMgr.get(t.Player).setNextLevelExp(e.role_info.next_lv_exp),LogicMgr.get(t.Player).setCoin(e.role_info.coin),LogicMgr.get(t.Player).setIngot(e.role_info.ingot),LogicMgr.get(t.Player).setVipLevel(e.role_info.vip_lv),LogicMgr.get(t.Player).setCamp(e.role_info.camp),this.finishedMessages=this.finishedMessages+1,this.finishedMessages===this.totalMessages&&(this.fireEvent(t.Login.EVT.ENTER_GAME),this.finishedMessages=0))},i.prototype.onGetBuildGuildList=function(e){LogicMgr.get(t.Build).setData(e.build_list),this.finishedMessages=this.finishedMessages+1,this.finishedMessages===this.totalMessages&&(this.fireEvent(t.Login.EVT.ENTER_GAME),this.finishedMessages=0)},i.prototype.onGetOwnSoldiers=function(e){console.log("onGetOwnSoldiers = "+e.soldiers[0]),LogicMgr.get(t.Camp).setSoldierIds(e.soldiers),this.finishedMessages=this.finishedMessages+1,this.finishedMessages==this.totalMessages&&(this.fireEvent(t.Login.EVT.ENTER_GAME),this.finishedMessages=0)},i.prototype.getServerListInfo=function(){return this.serverListInfo},i.prototype.getCurServerInfo=function(){return this.curServerInfo},i.prototype.setCurServerInfo=function(t){this.curServerInfo=t},i}(Logic);e.EVT=utils.Enum(["ENTER_GAME","REGISTER_ROLE","REFESH_SERVERINFO"]),t.Login=e,__reflect(e.prototype,"logic.Login");var i=function(){function t(){}return t}();t.ServerInfo=i,__reflect(i.prototype,"logic.ServerInfo")}(logic||(logic={}));var AssetAdapter=function(){function t(){}return t.prototype.getAsset=function(t,e,i){function o(o){e.call(i,o,t)}if(RES.hasRes(t)){var n=RES.getRes(t);n?o(n):RES.getResAsync(t,o,this)}else RES.getResByUrl(t,o,this,RES.ResourceItem.TYPE_IMAGE)},t}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var mo;!function(t){var e=function(){function t(t){this.data={},this.length=0,this.data=t}return t.prototype.load=function(t,e){this.hitPos=t,this.length=e},t.prototype.getData=function(t){return this.data[t]},t}();t.MapReader=e,__reflect(e.prototype,"mo.MapReader")}(mo||(mo={}));var mo;!function(t){var e=function(){function t(t,e,i,o,n){this.map=t,this.dynamicCells=i,this.creator=o,this.collector=n,this.pos={x:1/0,y:1/0},this.cells={},this.node=new eui.Group,this.node.width=e.width,this.node.height=e.height,e.addChild(this.node)}return t.prototype.getCellNode=function(t,e){var i=this.map.cell2index(t,e);return this.cells[i]},t.prototype.update=function(t,e,i){i.cells;this.updateTiles(i)},t.prototype.updateTiles=function(t){for(var e=t.cells,i=Object.keys(this.cells),o=i.length-1;o>=0;o--){var n=i[o],r=this.cells[n];void 0===e[n]&&(this.collector&&this.collector(r,n),this.node.removeChild(r),delete this.cells[n])}for(var s=t.keys,o=s.length-1;o>=0;o--){var n=e[s[o]];if(void 0!==n&&void 0===this.cells[n]){var r=this.creator(n);if(!r)continue;var a=this.map.index2cell(parseInt(n)),h=this.map.cell2world(a[0],a[1]);r.x=h[0],r.y=h[1],this.node.addChild(r),this.cells[n]=r}}},t}();t.Dynamic=e,__reflect(e.prototype,"mo.Dynamic")}(mo||(mo={}));var mo;!function(t){var e=function(){function t(t,e,i,o){this.viewSize=t,this.tileSize=e;var n=this.createTiles(o);this.offset=n.offset,this.node=n.node,this.node.cacheAsBitmap=!0,i.addChild(this.node)}return t.prototype.getNode=function(){return this.node},t.prototype.update=function(t,e){t=this.offset.x+t,e=this.offset.y+e;var i=[this.node.x,this.node.y],o=i[0],n=i[1];if(!(Math.abs(o-t)<this.tileSize.w&&Math.abs(n-e)<this.tileSize.h)){var r=(o-t)%this.tileSize.w,s=(n-e)%this.tileSize.h;a=[t+r,e+s],this.node.x=a[0],this.node.y=a[1];var a}},t.prototype.createTiles=function(t){for(var e={x:this.viewSize.width/2,y:this.viewSize.height/2},i=Math.ceil(this.viewSize.width/this.tileSize.w)+3,o=Math.ceil(this.viewSize.height/this.tileSize.h)+3,n=-Math.ceil(this.tileSize.w*i/2),r=-Math.ceil(this.tileSize.h*o/2),s=new eui.Group,a=0;i>a;a++)for(var h=0;o>h;h++){var l=t(),c=n+this.tileSize.w*a,p=r+this.tileSize.h*h;u=[c,p],l.x=u[0],l.y=u[1],s.addChild(l)}return{offset:e,node:s};var u},t}();t.Tile=e,__reflect(e.prototype,"mo.Tile")}(mo||(mo={}));var logic;!function(t){var e=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.setUid=function(t){this.uid=t},e.prototype.getUid=function(){return this.uid},e.prototype.setRoleId=function(t){this.roleId=t},e.prototype.getRoleId=function(){return this.roleId},e.prototype.setRoleName=function(t){this.roleName=t},e.prototype.getRoleName=function(){return this.roleName},e.prototype.setRoleLevel=function(t){this.roleLevel=t},e.prototype.getRoleLevel=function(){return this.roleLevel},e.prototype.setRoleExp=function(t){this.roleExp=t},e.prototype.getRoleExp=function(){return this.roleExp},e.prototype.setNextLevelExp=function(t){this.nextLevelExp=t},e.prototype.getNextLevelExp=function(){return this.nextLevelExp},e.prototype.setSvrId=function(t){this.svrId=t},e.prototype.getSvrId=function(){return this.svrId},e.prototype.setSvrName=function(t){this.svrName=t},e.prototype.getSvrName=function(){return this.svrName},e.prototype.setCoin=function(t){this.coin=t},e.prototype.getCoin=function(){return this.coin},e.prototype.setIngot=function(t){this.ingot=t},e.prototype.getIngot=function(){return this.ingot},e.prototype.setVipLevel=function(t){this.vipLevel=t},e.prototype.getVipLevel=function(){return this.vipLevel},e.prototype.setCamp=function(t){this.camp=t},e.prototype.getCamp=function(){return this.camp},e}(Logic);t.Player=e,__reflect(e.prototype,"logic.Player")}(logic||(logic={}));var UIMgr;!function(t){function e(t){p(t)}function i(){var t=r("home");return t.getChildAt(0)}function o(){var t=r("scene");return t.getChildAt(0)}function n(){var t=r("guide");return t.getChildAt(0)}function r(t){return d[t]}function s(t,e){void 0===e&&(e="panel");for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];var n=r(e),s=new(t.bind.apply(t,[void 0].concat(i)));return n.addChild(s),s}function a(t,e){void 0===e&&(e="panel");for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];for(var n=r(e),a=0;a<n.numChildren;a++){var h=n.getChildAt(a);if(h instanceof t)return}s.apply(void 0,[t,e].concat(i))}function h(t){t.parent&&t.removeFromParent()}function l(t,e){void 0===e&&(e="panel");for(var i=r(e),o=[],n=0;n<i.numChildren;n++){var s=i.getChildAt(n);s instanceof t&&o.push(s)}for(var a=0,h=o;a<h.length;a++){var s=h[a];s.removeFromParent()}}function c(t,e){var i=[];for(var o in d)for(var n=d[o],r=n.numChildren-1;r>=0;r--){var s=n.getChildAt(r);i.push(s)}i.forEach(function(i){var o=new egret.Event(t,!1,!0,e);i.dispatchEvent(o)})}function p(t){d={scene:new eui.UILayer,home:new eui.UILayer,panel:new eui.UILayer,effect:new eui.UILayer,guide:new eui.UILayer,mask:new eui.UILayer,load:new eui.UILayer},u=t;for(var e in d){var i=d[e];i.touchThrough=!0,u.addChild(i),o=[u.width,u.height],i.width=o[0],i.height=o[1]}u.touchThrough=!0;var o}var u,d;t.setup=e,t.getHome=i,t.getWorld=o,t.getGuide=n,t.getLayer=r,t.open=s,t.openOnce=a,t.close=h,t.closeAll=l,t.fireUIEvent=c}(UIMgr||(UIMgr={}));var logic;!function(t){var e=function(e){function i(){var t=e.call(this)||this;NetMgr.get(msg.Map).on("m_map_sight_toc",t.Event("onSightUpdate")),NetMgr.get(msg.Map).on("m_map_sight_enter_toc",t.Event("onSightEnter")),NetMgr.get(msg.Map).on("m_map_sight_leave_toc",t.Event("onSightLeave")),NetMgr.get(msg.Map).on("m_map_obj_move_info_toc",t.Event("onActorMove")),t.armyData={},t.unitData={},t.tabletData={};var i=mo.TMap.getMainData().getResult();return t.mapSize={cols:i.info.cols,rows:i.info.rows},t}return __extends(i,e),i.prototype.getViewObjects=function(t,e,i){void 0===i&&(i=0);var o={point:{x:t,y:e,z:i},width:config.MAP_UPDATE_COLS,height:config.MAP_UPDATE_ROWS};NetMgr.get(msg.Map).send("m_map_get_view_obj_tos",o)},i.prototype.moveArmyToCell=function(e,i,o){var n=LogicMgr.get(t.Build).getBuildIdByArmyId(e);if(n){var r={build_id:n,army_id:e,x:i,y:o};NetMgr.get(msg.Build).send("m_build_go_to_battle_tos",r)}},i.prototype.onSightUpdate=function(t){this.updateArmyData(t.army_list),this.updateUnitData(t.build_list),this.updateTabletData(this.unitData),this.fireEvent(i.EVT.SIGHT_UPDATE)},i.prototype.onSightEnter=function(t){for(var e=0,o=t.army_list;e<o.length;e++){var n=o[e];this.updateArmy(n)}this.fireEvent(i.EVT.SIGHT_UPDATE)},i.prototype.onSightLeave=function(t){for(var e=0,o=t.amy_id;e<o.length;e++){var n=o[e];this.removeArmy(n)}this.fireEvent(i.EVT.SIGHT_UPDATE)},i.prototype.getArmayData=function(){return this.armyData},i.prototype.getUnitData=function(){return this.unitData},i.prototype.getTabletData=function(){return this.tabletData},i.prototype.onActorMove=function(t){var e=this.armyData[t.obj_id];e&&(e.move_path=t.path,e.status=t.status,this.fireEvent(i.EVT.ACTOR_MOVE,e))},i.prototype.removeArmy=function(t){delete this.armyData[t]},i.prototype.updateArmy=function(t){this.armyData[t.army_id]=t},i.prototype.updateArmyData=function(t){var e=utils.convert2Object(t,function(t){return t.army_id});this.armyData=utils.mergeObject(e,this.armyData);var i={};for(var o in this.armyData){var n=this.armyData[o],r=this.makePos(n.cur_point.x,n.cur_point.y);this.viewCells[r]&&(i[o]=n)}this.armyData=i},i.prototype.updateUnitData=function(t){var e=this,i=utils.convert2Object(t,function(t){return e.makePos(t.x,t.y)});i=utils.mergeObject(i,this.unitData),this.unitData=utils.intersectObject(i,this.viewCells)},i.prototype.removeUnit=function(t,e){var i=this.makePos(t,e);delete this.unitData[i]},i.prototype.updateTabletData=function(t){this.tabletData={};for(var e in t){var i=t[e];1===i.type&&(this.tabletData[e]={x:i.x,y:i.y,type:0})}},i.prototype.setViewCells=function(t){this.viewCells=t},i.prototype.parsePos=function(t){var e=t%this.mapSize.cols,i=Math.floor(t/this.mapSize.cols);return{x:e,y:i}},i.prototype.makePos=function(t,e){return e*this.mapSize.cols+t},i.prototype.getUnitDataByPos=function(t){for(var e in this.unitData){var i=this.unitData[e];if(i.x===t.x&&i.y===t.y)return i}return{x:t.x,y:t.y}},i.prototype.searchCellPos=function(t,e){this.fireEvent(i.EVT.SEARCH_POS,t,e)},i.prototype.isDynamicBlocked=function(t){return!!this.unitData[t]},i.prototype.isBlocked=function(t,e){var i=this.makePos(t,e),o=this.isDynamicBlocked(i);return o||mo.TMap.getMainData().isBlocked(i,config.MAP_BLOCKED_LAYER_NAME)},i.prototype.buildUnit=function(t,e){var i=Math.random();this.unitData[i]={x:t,y:e,type:1,build_id:i}},i}(Logic);e.EVT=utils.Enum(["ENTER_MAP","SIGHT_UPDATE","SIGHT_LEAVE","SIGHT_ENTER","ACTOR_MOVE","SEARCH_POS","ADD_ARMY","DELETE_ARMY"]),t.World=e,__reflect(e.prototype,"logic.World")}(logic||(logic={}));var Main=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.createChildren=function(){t.prototype.createChildren.call(this),RES.processor.map("proto",ProtoAnalyzer);var e=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",e),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadRes(),NetMgr.init()},e.prototype.loadTheme=function(){var t=this,e=new eui.Theme("resource/default.thm.json",this.stage);return new Promise(function(i,o){e.addEventListener(eui.UIEvent.COMPLETE,i,t)})},e.prototype.loadRes=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,RES.loadConfig()];case 1:return t.sent(),[4,this.loadTheme()];case 2:return t.sent(),[4,RES.loadGroup("loading",0)];case 3:return t.sent(),this.startGame(),[2]}})})},e.prototype.gameUpdate=function(){Singleton(Timer).process()},e.prototype.startGame=function(){this.addEventListener(egret.Event.ENTER_FRAME,this.gameUpdate,this),UIMgr.setup(this),UIMgr.open(ui.NetTip,"mask"),UIMgr.open(ui.LoginLoadingUI,"load")},e}(eui.UILayer);Main=__decorate([RES.mapConfig("config.json",function(){return"resource"},function(t){var e=t.substr(t.lastIndexOf(".")+1),i={jpg:"image",png:"image",webp:"image",json:"json",fnt:"font",pvr:"pvr",mp3:"sound",proto:"proto"},o=i[e];return"json"==o&&(t.indexOf("sheet")>=0?o="sheet":t.indexOf("movieclip")>=0&&(o="movieclip")),o})],Main),__reflect(Main.prototype,"Main");var utils;!function(t){function e(t,e){return 180/Math.PI*Math.asin(t/e)}t.MahtSin=e}(utils||(utils={}));var world;!function(t){var e=function(){function e(t,e){this.manager=t,this.root=e,this.views={},this.amryViews={},this.data={},this.timer=new egret.Timer(1e3,0),this.timer.addEventListener(egret.TimerEvent.TIMER,this.resetChildIndex,this),this.timer.start()}return e.prototype.dispose=function(){},e.prototype.recycle=function(t){for(var e in this.amryViews)t[e]||this.removeArmy(e)},e.prototype.updatePath=function(t){this.amryViews[t.army_id]&&1===t.status&&(t.status=0,this.amryViews[t.army_id].updatePath(t))},e.prototype.updateData=function(t){for(var e in t)this.amryViews[e]?(this.amryViews[e].setData(t[e]),this.amryViews[e].refresh()):(this.amryViews[e]=new ArmyView(t[e],this.manager,this.root),this.amryViews[e].mergeViews(this.views));this.recycle(t)},e.prototype.updateArmy=function(t,e){this.views[t]?(this.views[t].setData(e),this.views[t].refresh()):this.views[t]=this.buildArmy(e)},e.prototype.buildArmy=function(e){return new t.Army(this.manager,this.root,e)},e.prototype.removeArmy=function(t){this.amryViews[t].dispose();var e=this.amryViews[t].getRoleViews();for(var i in e)delete this.views[i];delete this.amryViews[t]},e.prototype.resetChildIndex=function(){var t=this.getViews(),e=[],i=0;for(var o in t)e[i]=t[o],i++;for(var n=e.length,r=0;n>r;r++)for(var s=r+1;n>s;s++)e[r].vo.getY()>e[s].vo.getY()&&this.swap(e,r,s);for(var a=0;n>a;a++)e[a].parent.setChildIndex(e[a],a)},e.prototype.swap=function(t,e,i){var o=t[i];t[i]=t[e],t[e]=o},e.prototype.getViews=function(){return this.views},e.prototype.getRoot=function(){return this.root},e.prototype.getArmyViews=function(){return this.amryViews},e}();t.ArmyMgr=e,__reflect(e.prototype,"world.ArmyMgr")}(world||(world={}));var world;!function(t){var e=function(){function t(t,e){this.tasks=[],this.count=3,this.isStart=!1,this.manager=t,this.root=e}return t.prototype.dispose=function(){this.clear()},t.prototype.push=function(t,e,i){this.tasks.push({target:e,func:t,param:i}),this.isStart||this.start()},t.prototype.clear=function(){this.tasks=[]},t.prototype.update=function(){for(var t=0,e=0,i=this.tasks;e<i.length;e++){var o=i[e];if(++t>this.count)return;o.func.call(o.target,o.param)}this.stop()},t.prototype.start=function(){this.root.addEventListener(egret.Event.ENTER_FRAME,this.update,this),this.isStart=!0},t.prototype.stop=function(){this.root.removeEventListener(egret.Event.ENTER_FRAME,this.update,this),this.isStart=!1},t}();t.FrameTask=e,__reflect(e.prototype,"world.FrameTask")}(world||(world={}));var world;!function(t){var e=function(){function t(t,e){this.manager=t,this.mapLayer=e,this.worldMap=t.getWorldMap()}return t.prototype.getRectCenter=function(t){var e=t.org,i=e.x+(t.width||1)-1,o=e.y+(t.height||1)-1,n=this.worldMap.cell2world(e.x,e.y),r=n[0],s=n[1],a=this.worldMap.cell2world(i,o),h=(a[0],a[1]);return{x:r,y:(s+h)/2}},t.prototype.isPointInScene=function(t){var e=this.worldMap.cell2world(t.x,t.y),i=e[0],o=e[1],n=this.mapLayer.localToGlobal(i,o),r=this.worldMap.getViewSize(),s=new egret.Rectangle(0,0,r.width,r.height);return s.containsPoint(n)},t.prototype.getDisplayInfo=function(t){var e=this.worldMap.cell2world(t.x,t.y),i=e[0],o=e[1],n=this.worldMap.getCenterCPos(),r=this.worldMap.getCenterWPos();if(this.isPointInScene(t))return{show:!1,angle:0,cPosCenter:n};var s=i-r[0],a=o-r[1],h=Math.atan2(a,s);return{show:!0,angle:h,cPosCenter:n}},t.prototype.getDistance=function(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))},t}();t.Helper=e,__reflect(e.prototype,"world.Helper")}(world||(world={}));var world;!function(t){var e=function(){function e(e,i){this.listener=e,this.worldMap=i,this.mapLayer=i.getNode();var o=new egret.DisplayObjectContainer;this.mapLayer.addChild(o),o.width=o.height=0;var n=new egret.DisplayObjectContainer;this.mapLayer.addChild(n),n.width=n.height=0;var r=new egret.DisplayObjectContainer;this.mapLayer.addChild(r),r.width=r.height=0,this.uiLayer=new egret.DisplayObjectContainer,this.mapLayer.addChild(this.uiLayer),this.mapLayer.setChildIndex(this.uiLayer,99),this.uiLayer.width=this.uiLayer.height=0,this.helper=new t.Helper(this,this.mapLayer),this.frameTask=new t.FrameTask(this,this.mapLayer),this.buildMgr=new t.UnitMgr(this,n),this.tabletMgr=new t.UnitMgr(this,o),this.armyMgr=new t.ArmyMgr(this,r)}return e.prototype.dispose=function(){this.buildMgr.dispose(),this.tabletMgr.dispose(),this.armyMgr.dispose()},e.prototype.getListener=function(){return this.listener},e.prototype.getWorldMap=function(){return this.worldMap},e.prototype.getArmyMgr=function(){return this.armyMgr},e.prototype.getBuildMgr=function(){return this.buildMgr},e.prototype.getTabletMgr=function(){return this.tabletMgr},e.prototype.getHelper=function(){return this.helper},e.prototype.getFrameTask=function(){return this.frameTask},e.prototype.getUILayer=function(){return this.uiLayer},e.prototype.getGridData=function(t,e){var i=this.worldMap.cell2world(e.x,e.y),o={root:this.uiLayer,info:t,pos:{x:i[0],y:i[1]},grid:e};return o},e}();t.Manager=e,__reflect(e.prototype,"world.Manager")}(world||(world={}));var world;!function(t){var e=function(){function e(t,e){this.manager=t,this.root=e,this.worldMap=this.manager.getWorldMap(),this.views={},this.data={}}return e.prototype.dispose=function(){for(var t in this.views)this.views[t].dispose()},e.prototype.recycle=function(t){for(var e in this.views)t[e]||this.removeUnit(e)},e.prototype.checkHasBuildUnit=function(t){for(var e in this.views){var i=this.views[e],o=i.getData();if(t.x===o.x&&t.y===o.y)return!0}return!1},e.prototype.updateData=function(t){for(var e in t)this.updateUnit(e,t[e]);this.recycle(t)},e.prototype.updateUnit=function(t,e){this.views[t]?(this.views[t].setData(e),this.views[t].refresh()):!this.checkHasBuildUnit(t)&&e&&this.buildUnit(t,e)},e.prototype.buildUnit=function(e,i){var o={0:t.Tablet,1:t.Castle,2:t.Camp,3:t.Acacdemy,4:t.Arsenal},n=o[i.type];n&&(this.views[e]=new n(this.manager,this.root,i))},e.prototype.removeUnit=function(t){this.views[t].dispose(),delete this.views[t]},e}();t.UnitMgr=e,__reflect(e.prototype,"world.UnitMgr")}(world||(world={}));var ArmyView=function(){function t(t,e,i){this.roleViews={},this.countIndex=0,this.autoMoveHz=650,this.statue=0,this.data=t,this.manager=e,this.root=i,this.createArmy(),this.refresh()}return t.prototype.createArmy=function(){var t=[{soldiers_id:1,hp:100,max_hp:100},{soldiers_id:2,hp:100,max_hp:100},{soldiers_id:3,hp:100,max_hp:100}];this.army_id=this.data.army_id;for(var e=void 0,i=0,o=0,n=t;o<n.length;o++){var r=n[o];i++;var s=new RoleView(this.root),a=this.army_id+""+(r.soldiers_id+i);this.roleViews[a]=s,this.root.addChild(s);var h=this.manager.getWorldMap().cell2world(this.data.cur_point.x,this.data.cur_point.y),l=new PlayerVO;l.setXY(h[0],h[1]),l.setCellXY(this.data.cur_point.x,this.data.cur_point.y);var c=new PlayerVO;l.setId(parseInt(a)),s.updateVO(l,c),this.mainRole||(this.mainRole=s),e&&s.setFrontRoleView(e),e=s}},t.prototype.frameExecute=function(){if(this.countIndex++,this.countIndex%this.autoMoveHz===0){var t=Math.floor(10*Math.random()),e=Math.floor(10*Math.random()),i="0";for(var o in this.roleViews){i=o;break}var n={role_id:i,move_path:[{x:t,y:e}]};UIMgr.getWorld().onActorMove(n)}},t.prototype.setData=function(t){this.data=t},t.prototype.refresh=function(){1===this.data.status&&(this.data.status=0,this.mainRole.updatePath(this.data))},t.prototype.updatePath=function(t){this.mainRole.updatePath(t)},t.prototype.mergeViews=function(t){utils.mergeObject(this.roleViews,t)},t.prototype.getMainViews=function(){var t=new Array;for(var e in this.roleViews)t.push(e);return this.roleViews[t[0]]},t.prototype.getRoleViews=function(){return this.roleViews},t.prototype.getNextRoleView=function(t){var e=new Array;for(var i in this.roleViews)e.push(i);for(var o=0;o<e.length;o++)if(o<e.length-1&&t===this.roleViews[e[o]])return this.roleViews[e[o+1]]},t.prototype.getOtherRoleView=function(t){var e={};for(var i in this.roleViews)this.roleViews[i]!==t&&(e[i]=this.roleViews[i]);return e},t.prototype.setSelectView=function(t){this.selectView=t},t.prototype.getSelectView=function(){return this.selectView},t.prototype.dispose=function(){for(var t in this.roleViews)this.roleViews[t].dispose()},t}();__reflect(ArmyView.prototype,"ArmyView");var world;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.build=function(){return this.createView("ziyuanyanjiusuo_png")},e}(t.ViewBase);t.Acacdemy=e,__reflect(e.prototype,"world.Acacdemy")}(world||(world={}));var world;!function(t){var e=function(t){function e(e,i,o){return t.call(this,e,i,o)||this}return __extends(e,t),e.prototype.build=function(){var t=new RoleView;return t.anchorOffsetX=30,t.anchorOffsetY=10,t},e.prototype.refresh=function(){var t=this.worldMap.cell2world(this.data.cur_point.x,this.data.cur_point.y),e=new PlayerVO;e.setXY(t[0],t[1]),this.view.updateVO(e),1===this.data.status&&this.view.updatePath(this.data)},e}(t.ViewBase);t.Army=e,__reflect(e.prototype,"world.Army")}(world||(world={}));var world;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.build=function(){return this.createView("leiyansuo_png")},e}(t.ViewBase);t.Arsenal=e,__reflect(e.prototype,"world.Arsenal")}(world||(world={}));var world;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.build=function(){return this.createView("junxing_png")},e}(t.ViewBase);t.Camp=e,__reflect(e.prototype,"world.Camp")}(world||(world={}));var world;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.build=function(){return this.createView("yinbenzhongxin_png")},e}(t.ViewBase);t.Castle=e,__reflect(e.prototype,"world.Castle")}(world||(world={}));var world;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.build=function(){return this.createView("leida_png")},e}(t.ViewBase);t.Radar=e,__reflect(e.prototype,"world.Radar")}(world||(world={}));var world;!function(t){var e=function(t){function e(e,i,o){return t.call(this,e,i,o)||this}return __extends(e,t),e}(t.ViewBase);t.Resource=e,__reflect(e.prototype,"world.Resource")}(world||(world={}));var world;!function(t){var e=function(t){function e(e,i,o){return t.call(this,e,i,o)||this}return __extends(e,t),e.prototype.build=function(){var t=new egret.DisplayObjectContainer,e=RES.getRes("shuinidi_png"),i=new eui.Image(e);return t.addChild(i),i.touchEnabled=!1,i.anchorOffsetX=e.bitmapData.width/2,i.anchorOffsetY=e.bitmapData.height/2,t},e.prototype.refresh=function(){var t=this.worldMap.cell2world(this.data.x,this.data.y);e=[t[0],t[1]],this.view.x=e[0],this.view.y=e[1];var e},e}(t.ViewBase);t.Tablet=e,__reflect(e.prototype,"world.Tablet")}(world||(world={}));var msg;!function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.proto="net/proto.proto",e.modId=140,e.subIds={1:"m_army_get_own_soldier_tos",2:"m_army_get_own_soldier_toc",3:"m_army_set_soldier_tos",4:"m_army_set_soldier_toc"},e}return __extends(e,t),e.prototype.on=function(e,i){t.prototype.on.call(this,e,i)},e.prototype.send=function(e,i){t.prototype.send.call(this,e,i)},e}(NetMsg);t.Army=e,__reflect(e.prototype,"msg.Army")}(msg||(msg={}));var msg;!function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.modId=130,e.subIds={0:"m_build_get_build_list_tos",1:"m_build_get_build_list_toc",2:"m_build_go_to_battle_tos",3:"m_build_go_to_battle_toc"},e}return __extends(e,t),e.prototype.on=function(e,i){t.prototype.on.call(this,e,i)},e.prototype.send=function(e,i){t.prototype.send.call(this,e,i)},e}(NetMsg);t.Build=e,__reflect(e.prototype,"msg.Build")}(msg||(msg={}));var msg;!function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.modId=100,e.subIds={0:"m_login_auth_tos",1:"m_login_auth_toc",2:"m_login_create_role_tos",3:"m_login_create_role_toc",4:"m_login_get_role_detail_tos",5:"m_login_get_role_detail_toc"},e}return __extends(e,t),e.prototype.on=function(e,i){t.prototype.on.call(this,e,i)},e.prototype.send=function(e,i){t.prototype.send.call(this,e,i)},e}(NetMsg);t.Login=e,__reflect(e.prototype,"msg.Login")}(msg||(msg={}));var msg;!function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.modId=120,e.subIds={0:"m_map_get_view_obj_tos",1:"m_map_sight_toc",2:"m_map_sight_leave_toc",3:"m_map_sight_enter_toc",6:"m_map_obj_move_info_toc"},e}return __extends(e,t),e.prototype.on=function(e,i){t.prototype.on.call(this,e,i)},e.prototype.send=function(e,i){t.prototype.send.call(this,e,i)},e}(NetMsg);t.Map=e,__reflect(e.prototype,"msg.Map")}(msg||(msg={}));var ThemeAdapter=function(){function t(){}return t.prototype.getTheme=function(t,e,i,o){function n(t){e.call(o,t)}function r(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),i.call(o))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),RES.getResByUrl(t,n,this,RES.ResourceItem.TYPE_TEXT)},t}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var ui;!function(t){var e=function(e){function i(t,o){var n=e.call(this,i.CUSTOM)||this;return n.world=t,n.data=o,n.lbInfo.text=o.info.x+", "+o.info.y,n.btnBuild.visible=!1,LogicMgr.get(logic.World).isBlocked(o.info.x,o.info.y)?n.lbInfo.text="阻挡！":n.btnBuild.visible=!0,n}return __extends(i,e),i.prototype.onExit=function(){e.prototype.onExit.call(this),this.world=null},i.prototype.onBtnBack=function(t){console.log("onBtnBack"),this.world.closeItem()},i.prototype.onBtnBuild=function(t){console.log("onBtnBuild"),LogicMgr.get(logic.World).buildUnit(this.data.info.x,this.data.info.y),this.world.onSightUdpate(),this.world.closeItem()},i.prototype.onBtnAction=function(e){console.log("onBtnAction"),this.world.closeItem();var i=LogicMgr.get(logic.Build).getAllArmyInfo();0!==i.length&&UIMgr.open(t.ArmyMove,void 0,this.data)},i}(UIBase);e.CUSTOM={skinName:"resource/ui/ActionMenuUISkin.exml",binding:(i={},i.btnBack={method:"onBtnBack"},i.btnAction={method:"onBtnAction"},i.btnBuild={method:"onBtnBuild"},i)},t.ActionMenu=e,__reflect(e.prototype,"ui.ActionMenu");var i}(ui||(ui={}));var ui;!function(t){var e=function(t){function e(i,o){var n=t.call(this,e.CUSTOM)||this;n.world=i,n.data=o,n.lbPos.text="("+o.info.x+","+o.info.y+")";var r=LogicMgr.get(logic.Build).getConfig(o.info.type);return r?(n.lbTitle.text=r.name+"  (LV"+r.lv+")",n):n}return __extends(e,t),e.prototype.onEnter=function(){var e=this;t.prototype.onEnter.call(this);var i=100;this.world.getMapContainer().setPosWithAnimat(this.data.pos.x,this.data.pos.y+i,200,function(){return e.delayShow()}),this.gpMainPos.visible=!1},e.prototype.onExit=function(){t.prototype.onExit.call(this),this.world=null},e.prototype.delayShow=function(){if(this.world){var t=this.world.getMap().cell2world(this.data.info.x,this.data.info.y),e=this.world.getMap().getNode().localToGlobal(t[0],t[1]),i=this.globalToLocal(e.x,e.y);this.gpMainPos.x=i.x,this.gpMainPos.y=i.y,this.gpMainPos.visible=!0}},e.prototype.onBtnFunc=function(t){Prompt.popTip("功能开发中")},e.prototype.onBtnFinish=function(t){Prompt.popTip("功能开发中")},e.prototype.onBtnInfo=function(t){Prompt.popTip("功能开发中")},e}(UIBase);e.CUSTOM={closeBg:{alpha:0},skinName:"resource/ui/BuildMenuUISkin.exml",binding:(i={},i.btnFunc={method:"onBtnFunc"},i.btnFinish={method:"onBtnFinish"},i.btnInfo={method:"onBtnInfo"},i)},t.BuildMenu=e,__reflect(e.prototype,"ui.BuildMenu");var i}(ui||(ui={}));var ui;!function(t){var e=function(t){function e(i){var o=t.call(this,e.CUSTOM)||this;return o.param=i,o.seletedArmys=new Map,o}return __extends(e,t),e.prototype.onDeleteArmy=function(t){console.log("===onDeleteArmy"+t),this.seletedArmys.get(t)&&this.seletedArmys["delete"](t)},e.prototype.onAddArmy=function(t){console.log("===onAddArmy"+t),this.seletedArmys.get(t)||this.seletedArmys.set(t,parseInt(t))},e.prototype.onEnter=function(){t.prototype.onEnter.call(this),this.lstArmy.addEventListener(eui.ItemTapEvent.ITEM_TAP,this.onChange,this);var e=LogicMgr.get(logic.Build).getAllArmyInfo(),i=this.getData(e);this.refresh(i),LogicMgr.get(logic.World).on(logic.World.EVT.ADD_ARMY,this.Event("onAddArmy")),LogicMgr.get(logic.World).on(logic.World.EVT.DELETE_ARMY,this.Event("onDeleteArmy"))},e.prototype.getData=function(t){for(var e=[],i=0;i<t.length;i++){var o={armyName:null,strength:null,speed:null,status:null,dis:null,time:null,icon:null,selected:!1};o.armyName=t[i].army_id,o.strength=t[i].forward_phalanx.hp+t[i].center_phalanx.hp+t[i].back_phalanx.hp,o.speed=70,o.status="空闲",o.dis=0,o.time="00:00:00",o.icon="chuzheng_icon_buduichuzheng_s4_png",e.push(o)}return e},e.prototype.refresh=function(t){this.lstArmy.dataProvider=new eui.ArrayCollection(t)},e.prototype.onChange=function(t){},e.prototype.onBtnClose=function(){console.log("onBtnClose"),this.removeFromParent()},e.prototype.onBtnOK=function(){this.removeFromParent(),console.log("onBtnOK");for(var t,e=this.seletedArmys.values()[Symbol.iterator]();!(t=e.next()).done;)console.log(t.value),LogicMgr.get(logic.World).moveArmyToCell(t.value,this.param.info.x,this.param.info.y)},e}(UIBase);e.CUSTOM={closeBg:{alpha:.5,disable:!1},skinName:"resource/ui/ArmyMove/ArmyMoveUISkin.exml",binding:(i={},i.btnClose={method:"onBtnClose"},i.btnOK={method:"onBtnOK"},i)},t.ArmyMove=e,__reflect(e.prototype,"ui.ArmyMove");var i}(ui||(ui={}));var ui;!function(t){var e=function(t){function e(i){var o=t.call(this,e.CUSTOM)||this;return o.enableTouch(),o}return __extends(e,t),e.prototype.onCheckBox=function(){this.checkBox.selected?LogicMgr.get(logic.World).fireEvent(logic.World.EVT.ADD_ARMY,this.armyName.text):LogicMgr.get(logic.World).fireEvent(logic.World.EVT.DELETE_ARMY,this.armyName.text)
},e}(IRBase);e.CUSTOM={skinName:"resource/ui/ArmyMove/ArmyMoveListIRSkin.exml",binding:(i={},i.checkBox={method:"onCheckBox"},i)},t.ArmyMoveItem=e,__reflect(e.prototype,"ui.ArmyMoveItem");var i}(ui||(ui={}));var ui;!function(t){var e=function(t){function e(){return t.call(this,e.CUSTOM)||this}return __extends(e,t),e.prototype.onEnter=function(){t.prototype.onEnter.call(this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),this.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this),LogicMgr.get(logic.Camp).on(logic.Camp.EVT.SOLDIER_TOUCH_BEGIN,this.Event("onSoldierTouchBegin")),NetMgr.get(msg.Army).on("m_army_set_soldier_toc",this.Event("onArmySetSoldier")),this.soldierData=RES.getRes("SoldierConfig_json");var e=this.getDataByType(i.Human);this.refeshData(e),this.point=new egret.Point,this.initArmy()},e.prototype.onArmySetSoldier=function(t){},e.prototype.initArmy=function(){for(var t=LogicMgr.get(logic.Build).getAllArmyInfo(),e=0;e<t.length;e++)this.refeshForWrdPhalanx(t[e].forward_phalanx),this.refeshCenterPhalanx(t[e].center_phalanx),this.refeshBackPhalanx(t[e].back_phalanx)},e.prototype.refeshForWrdPhalanx=function(t){0!==t.soldiers_id&&(this.preHeadGroup.visible=!0)},e.prototype.refeshCenterPhalanx=function(t){0!==t.soldiers_id&&(this.midHeadGroup.visible=!0)},e.prototype.refeshBackPhalanx=function(t){0!==t.soldiers_id&&(this.backHeadGroup.visible=!0)},e.prototype.setSoldier=function(t,e,i,o){var n={build_id:t,army_id:e,pos:i,soldier_type:o};NetMgr.get(msg.Army).send("m_army_set_soldier_tos",n)},e.prototype.onTouchBegin=function(t){console.log("CampMain===onBegin"),this.point.x=t.stageX,this.point.y=t.stageY},e.prototype.onTouchMove=function(t){return console.log("CampMain===onMove"),0!=this.isClickedItem&&this.group?(this.group.x+=t.stageX-this.point.x,this.group.y+=t.stageY-this.point.y,this.point.x=t.stageX,void(this.point.y=t.stageY)):(this.point.x=t.stageX,void(this.point.y=t.stageY))},e.prototype.onTouchEnd=function(t){if(console.log("CampMain===onTouchEnd"),0!=this.isClickedItem&&this.group){if(this.isClickedItem=!1,this.group.parent.removeChild(this.group),this.group=null,this.preGroup.hitTestPoint(t.stageX,t.stageY)){console.log("====this.preGroup");var e=LogicMgr.get(logic.Build).getAllArmyInfo();e[0].forward_phalanx.soldiers_id=parseInt(this.data.id),e[0].forward_phalanx.hp=100,this.refeshForWrdPhalanx(e[0].forward_phalanx);var i=LogicMgr.get(logic.Build).getBuildIdByArmyId(e[0].army_id);this.setSoldier(i,e[0].army_id,1,parseInt(this.data.id))}if(this.midGroup.hitTestPoint(t.stageX,t.stageY)){console.log("===midGroup");var e=LogicMgr.get(logic.Build).getAllArmyInfo();e[0].center_phalanx.soldiers_id=parseInt(this.data.id),e[0].center_phalanx.hp=100,this.refeshCenterPhalanx(e[0].center_phalanx);var i=LogicMgr.get(logic.Build).getBuildIdByArmyId(e[0].army_id);this.setSoldier(i,e[0].army_id,2,parseInt(this.data.id))}if(this.backGroup.hitTestPoint(t.stageX,t.stageY)){console.log("===backGroup");var e=LogicMgr.get(logic.Build).getAllArmyInfo();e[0].back_phalanx.soldiers_id=parseInt(this.data.id),e[0].back_phalanx.hp=100,this.refeshBackPhalanx(e[0].back_phalanx);var i=LogicMgr.get(logic.Build).getBuildIdByArmyId(e[0].army_id);this.setSoldier(i,e[0].army_id,3,parseInt(this.data.id))}}},e.prototype.onSoldierTouchBegin=function(t,e){this.group=t,this.groupPoint=this.group.localToGlobal(0,0),this.group.parent.removeChild(this.group),this.addChild(this.group),this.group.x=this.groupPoint.x,this.group.y=this.groupPoint.y,this.isClickedItem=!0,this.data=e},e.prototype.getDataByType=function(t){var e=[];for(var i in this.soldierData){var o={id:null,type:null,fight_type:null,name:null};o.id=i,o.type=this.soldierData[i].type,o.fight_type=this.soldierData[i].fight_type,o.name=this.soldierData[i].name,e.push(o)}return e},e.prototype.refeshData=function(t){this.soldierList.dataProvider=new eui.ArrayCollection(t)},e.prototype.onBtnHum=function(){console.log("onBtnHum")},e.prototype.onBtnChariot=function(){console.log("onBtnChariot")},e.prototype.onBtnFighter=function(){console.log("onBtnFighter")},e.prototype.onBtnBiochemical=function(){console.log("onBtnBiochemical")},e.prototype.onBtnClose=function(){console.log("onBtnClose"),this.removeFromParent()},e.prototype.onChange=function(t){},e}(UIBase);e.CUSTOM={skinName:"resource/ui/Camp/CampUISkin.exml",binding:(o={},o.btn_Hum={method:"onBtnHum"},o.btn_Chariot={method:"onBtnChariot"},o.btn_Fighter={method:"onBtnFighter"},o.btn_Biochemical={method:"onBtnBiochemical"},o.btnClose={method:"onBtnClose"},o)},t.CampMain=e,__reflect(e.prototype,"ui.CampMain");var i;!function(t){t[t.Human=1]="Human",t[t.Chariot=2]="Chariot",t[t.Fighter=3]="Fighter",t[t.Biochemical=4]="Biochemical"}(i||(i={}));var o}(ui||(ui={}));var ui;!function(t){var e=function(t){function e(){return t.call(this,e.CUSTOM)||this}return __extends(e,t),e.prototype.onEnter=function(){t.prototype.onEnter.call(this),console.log("=================SoilderHeadItemUISkin"),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this)},e.prototype.onBtnClicked=function(){console.log("onBtnClicked")},e.prototype.onTouchBegin=function(t){console.log("========onBegin"),this.group=new eui.Group,this.group.x=0,this.group.y=0,this.soldierItem.addChild(this.group),this.img1=new eui.Image(this.img_bg.texture),this.img1.x=this.img_bg.x,this.img1.y=this.img_bg.y,this.img1.width=this.img_bg.width,this.img1.height=this.img_bg.height,this.img1.scaleX=this.img_bg.scaleX,this.img1.scaleY=this.img_bg.scaleY,this.group.addChild(this.img1),this.img2=new eui.Image(this.img_bg0.texture),this.img2.x=this.img_bg0.x,this.img2.y=this.img_bg0.y,this.img2.scaleX=this.img_bg0.scaleX,this.img2.scaleY=this.img_bg0.scaleY,this.group.addChild(this.img2),this.group.visible=!0,LogicMgr.get(logic.Camp).fireEvent(logic.Camp.EVT.SOLDIER_TOUCH_BEGIN,this.group,this.data)},e}(IRBase);e.CUSTOM={skinName:"resource/ui/Camp/SoilderHeadItemUISkin.exml"},t.SoldierHeadItem=e,__reflect(e.prototype,"ui.SoldierHeadItem")}(ui||(ui={}));var ui;!function(t){var e=function(t){function e(){var i=t.call(this,e.CUSTOM)||this;return i.createGrideList(),i}return __extends(e,t),e.prototype.createGrideList=function(){this.group=new eui.Group,this.mScroller.viewport=this.group;for(var t=1;200>=t;++t){var e=new eui.Button;e.label="按钮"+(10>t?"0":"")+t,this.group.addChild(e)}var o=new eui.TileLayout;o.paddingTop=30,o.paddingLeft=30,o.paddingRight=30,o.paddingBottom=30,this.group.layout=o,this._iAlignMode=i.GAP,o.columnAlign=eui.ColumnAlign.JUSTIFY_USING_GAP,o.rowAlign=eui.RowAlign.JUSTIFY_USING_GAP},e}(UIBase);e.CUSTOM={skinName:"resource/ui/CampUISkin.exml"},t.CampDetail=e,__reflect(e.prototype,"ui.CampDetail");var i=function(){function t(){}return t}();i.GAP=0,i.WH=1,__reflect(i.prototype,"AlignMode")}(ui||(ui={}));var ui;!function(t){var e=function(e){function o(){return e.call(this,o.CUSTOM)||this}return __extends(o,e),o.prototype.onEnter=function(){e.prototype.onEnter.call(this),LogicMgr.get(logic.Login).on(logic.Login.EVT.ENTER_GAME,this.Event("onEnterGame"))},o.prototype.onEnterGame=function(){this.removeFromParent(),this.btnCreateRole=null,this.radioBtnBoy=null,this.radiobtnGirl=null,this.roleName=null,UIMgr.open(t.GameLoadingUI,"load")},o.prototype.onBtnCreateRole=function(){if(0===this.roleName.text.length||""===this.roleName.text)return void alert("账号不能为空");var t;t=this.radioBtnBoy.selected?i.Boy:i.Girl;var e=1,o={sex:t,nick:this.roleName.text,camp:e};NetMgr.get(msg.Login).send("m_login_create_role_tos",o)},o}(UIBase);e.CUSTOM={skinName:"resource/ui/CreateRoleUISkin.exml",binding:(o={},o.btnCreateRole={event:egret.TouchEvent.TOUCH_TAP,method:"onBtnCreateRole"},o)},t.CreateRole=e,__reflect(e.prototype,"ui.CreateRole");var i;!function(t){t[t.Boy=1]="Boy",t[t.Girl=2]="Girl"}(i||(i={}));var o}(ui||(ui={}));var ui;!function(t){var e=function(e){function i(){return e.call(this,i.CUSTOM)||this}return __extends(i,e),i.prototype.onEnter=function(){e.prototype.onEnter.call(this),this.loadRes()},i.prototype.setProgress=function(t,e){this.progress.minimum=t/e*100},i.prototype.loadRes=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,o,n,r,s=this;return __generator(this,function(a){switch(a.label){case 0:return t=this,e={onProgress:function(e,i){t.setProgress(e,i)}},[4,RES.loadGroup("preload",0,e)];case 1:a.sent(),i=0,o=config.MAP_URLS,a.label=2;case 2:return i<o.length?(n=o[i],[4,RES.getResAsync(n)]):[3,5];case 3:a.sent(),a.label=4;case 4:return i++,[3,2];case 5:return r=new egret.Timer(0,1),r.addEventListener(egret.TimerEvent.TIMER,function(){return s.startCreateScene()},this),r.start(),[2]}})})},i.prototype.startCreateScene=function(){console.log("startCreateScene"),UIMgr.open(t.World,"scene"),UIMgr.open(t.Home,"home"),UIMgr.open(t.Guide,"guide"),this.removeFromParent()},i}(UIBase);e.CUSTOM={skinName:"resource/ui/LoadingUISkin.exml"},t.GameLoadingUI=e,__reflect(e.prototype,"ui.GameLoadingUI")}(ui||(ui={}));var ui;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.percentWidth=100,e.percentHeight=100,e.$setTouchEnabled(!1),e}return __extends(e,t),e.prototype.createGuide=function(t){var e=RES.getRes("GuideMotherConfig_json"),i=e[t].isBottom,o=e[t].layer,n=null;if("Home"===o)n=UIMgr.getHome();else if("World"===o)n=UIMgr.getWorld();else{var r=UIMgr.getLayer("Pannel");n=r.getChildAt(r.numChildren-1)}var s=n[e[t].btn];this.createGuidePanel(s,i)},e.prototype.createGuidePanel=function(t,e){var i=this,o=t.localToGlobal(0,0),n=o.x,r=o.y,s=t.width,a=t.height;this.guideGroup=new eui.Group,this.guideGroup.percentWidth=100,this.guideGroup.percentHeight=100,this.guideGroup.$setX(0),this.guideGroup.$setY(0),this.guideGroup.$setTouchEnabled(!1),this.addChild(this.guideGroup),this.createMask(n,r,s,a,e);var h=new eui.Group;h.percentWidth=100,h.height=200,this.guideGroup.addChild(h),e?(h.bottom=0,h.anchorOffsetY=200,h.$setY(this.stage.$stageHeight)):(h.anchorOffsetY=0,h.$setY(0)),h.$setX(0),h.$setTouchEnabled(!1);var l=h.globalToLocal(n+s/2,r+a/2),c=new eui.Image("finger1_png");c.$setX(l.x+10*Math.cos(Math.PI/4)),c.$setY(l.y+10*Math.sin(Math.PI/4));var p=egret.Tween.get(c,{loop:!0});p.to({x:l.x,y:l.y},500).to({x:l.x+10*Math.cos(Math.PI/4),y:l.y+10*Math.sin(Math.PI/4)},500),h.addChild(c);var u=new eui.Rect(s,a,131586),d=h.globalToLocal(n,r);h.addChild(u),u.fillAlpha=0,u.$setX(d.x),u.$setY(d.y),u.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(e){t.dispatchEvent(e)},this),u.addEventListener(egret.TouchEvent.TOUCH_TAP,function(e){t.dispatchEvent(e),i.addEventListener(egret.Event.RENDER,i.render,i)},this)},e.prototype.render=function(){this.removeEventListener(egret.Event.RENDER,this.render,this),this.finishedGuide()},e.prototype.createMask=function(t,e,i,o,n){var r=new eui.Rect(t,this.stage.$stageHeight,131586);this.guideGroup.addChild(r),r.fillAlpha=.5,r.$setX(0),r.$setY(0),r.percentHeight=100;var s=new eui.Rect(i,e,131586);this.guideGroup.addChild(s),s.fillAlpha=.5,s.$setX(t),s.$setY(0),n&&(s.top=0,s.bottom=this.stage.$stageHeight-e);var a=new eui.Rect(this.stage.$stageWidth-i-t,this.stage.$stageHeight,131586);this.guideGroup.addChild(a),a.fillAlpha=.5,a.$setX(t+i),a.$setY(0),a.percentHeight=100;var h=new eui.Rect(i,this.stage.$stageHeight-o-e,131586);this.guideGroup.addChild(h),h.fillAlpha=.5,h.$setX(t),h.$setY(e+o),h.bottom=0,n||(h.top=e+o)},e.prototype.finishedGuide=function(){this.guideGroup&&(this.guideGroup.parent.removeChild(this.guideGroup),this.guideGroup=null,LogicMgr.get(logic.Guide).finishAction())},e}(eui.Group);t.Guide=e,__reflect(e.prototype,"ui.Guide")}(ui||(ui={}));var ui;!function(t){var e=function(e){function i(){var t=e.call(this,i.CUSTOM)||this;return t.addEventListener(egret.Event.RENDER,t.render,t),t}return __extends(i,e),i.prototype.render=function(){this.removeEventListener(egret.Event.RENDER,this.render,this),this.chatText1=new egret.TextField,this.chatText2=new egret.TextField;var t=this.headChat1.x,e=this.headChat1.y,i=this.headChat2.y,o=25;this.chatText1.x=t+o,this.chatText1.y=e,this.chatText2.x=t+o,this.chatText2.y=i,this.chatGroup.addChild(this.chatText1),this.chatGroup.addChild(this.chatText2),this.createChatText()},i.prototype.onEnter=function(){e.prototype.onEnter.call(this)},i.prototype.onBtnHome=function(t){new eui.Label;console.log("onBtnHome"),Prompt.popTip("This is a tip -- "+Math.random())},i.prototype.onBtnBag=function(t){console.log("onBtnBag")},i.prototype.onBtnHero=function(t){console.log("onBtnHero")},i.prototype.createChatText=function(){this.chatText1.textFlow=[{text:"(硬汉部队) ",style:{size:18,textColor:10584252}},{text:"皇菜菜 ",style:{size:18,textColor:13144432}},{text:"：通关之路又进一步",style:{size:18,textColor:12301998}}],this.chatText2.textFlow=[{text:"(硬汉部队) ",style:{size:18,textColor:10584252}},{text:"皇菜菜 ",style:{size:18,textColor:13144432}},{text:"：通关之路又进一步",style:{size:18,textColor:12301998}}]},i.prototype.onBtnTroops=function(){Prompt.popTip("功能开发中"),UIMgr.open(t.CampMain)},i.prototype.onBtnSoilder=function(){Prompt.popTip("功能开发中")},i.prototype.onBtnGoods=function(){Prompt.popTip("功能开发中")},i.prototype.onBtnTask=function(){Prompt.popTip("功能开发中")},i.prototype.onBtnRecruit=function(){Prompt.popTip("功能开发中")},i.prototype.onBtnShop=function(){Prompt.popTip("功能开发中")},i.prototype.onBtnActivity=function(){Prompt.popTip("功能开发中a");for(var t=LogicMgr.get(logic.Build).getAllArmyInfo(),e=0;e<t.length;e++){var i=LogicMgr.get(logic.Build).getBuildIdByArmyId(t[e].army_id),o=t[e].army_id,n=1,r=1,s={build_id:i,army_id:o,pos:n,soldier_type:r};NetMgr.get(msg.Army).send("m_army_set_soldier_tos",s)}},i}(UIBase);e.CUSTOM={skinName:"resource/ui/HomeUISkin.exml",binding:(i={},i.btnTroops={method:"onBtnTroops"},i.btnSoilder={method:"onBtnSoilder"},i.btnGoods={method:"onBtnGoods"},i.btnTask={method:"onBtnTask"},i.btnRecruit={method:"onBtnRecruit"},i.btnShop={method:"onBtnShop"},i.btnActivity={method:"onBtnActivity"},i)},t.Home=e,__reflect(e.prototype,"ui.Home");var i}(ui||(ui={}));var ui;!function(t){var e=function(e){function i(){return e.call(this,i.CUSTOM)||this}return __extends(i,e),i.prototype.onEnter=function(){e.prototype.onEnter.call(this),LogicMgr.get(logic.Login).on(logic.Login.EVT.REGISTER_ROLE,this.Event("onRegisterRole")),LogicMgr.get(logic.Login).on(logic.Login.EVT.ENTER_GAME,this.Event("onEnterGame")),LogicMgr.get(logic.Login).on(logic.Login.EVT.REFESH_SERVERINFO,this.Event("refeshServerInfo")),this.refeshServerInfo()},i.prototype.refeshServerInfo=function(){var t=LogicMgr.get(logic.Login).getCurServerInfo();t&&(this.serverName.text=t.name)},i.prototype.onEnterGame=function(){this.removeFromParent(),this.account=null,this.group=null,UIMgr.open(t.GameLoadingUI,"load")},i.prototype.onRegisterRole=function(){this.removeFromParent(),this.account=null,this.group=null,UIMgr.open(t.CreateRole)},i.prototype.onBtnLogin=function(t){return 0==this.account.text.length||""==this.account.text?void alert("账号不能为空"):void this.doLogin()},i.prototype.doLogin=function(){var t=LogicMgr.get(logic.Login).getCurServerInfo();console.log("serverInfo ip = "+t.ip),console.log("serverInfo port = "+t.port),Singleton(NetCenter).connectServer(t.ip,t.port);var e={aid:this.account.text},i=LogicMgr.get(logic.Player);i.setUid(this.account.text),NetMgr.get(msg.Login).send("m_login_auth_tos",e)},i.prototype.onBtnServer=function(){UIMgr.open(t.ServerList)},i}(UIBase);e.CUSTOM={skinName:"resource/ui/LoginUISkin.exml",binding:(i={},i.btnLogin={event:egret.TouchEvent.TOUCH_TAP,method:"onBtnLogin"},i.btnServer={event:egret.TouchEvent.TOUCH_TAP,method:"onBtnServer"},i)},t.Login=e,__reflect(e.prototype,"ui.Login");var i}(ui||(ui={}));var ui;!function(t){var e=function(e){function i(){return e.call(this,i.CUSTOM)||this}return __extends(i,e),i.prototype.onEnter=function(){e.prototype.onEnter.call(this),this.loadRes()},i.prototype.setProgress=function(t,e){this.progress.minimum=t/e*100},i.prototype.loadRes=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,o=this;return __generator(this,function(n){switch(n.label){case 0:return t=this,e={onProgress:function(e,i){t.setProgress(e,i)}},[4,RES.loadGroup("login",0,e)];case 1:return n.sent(),[4,RES.loadGroup("camp")];case 2:return n.sent(),[4,RES.loadGroup("data")];case 3:return n.sent(),t.removeFromParent(),i=new egret.Timer(0,1),i.addEventListener(egret.TimerEvent.TIMER,function(){return o.startCreateScene()},this),i.start(),[2]}})})},i.prototype.startCreateScene=function(){UIMgr.open(t.Login,"panel")},i}(UIBase);e.CUSTOM={skinName:"resource/ui/LoadingUISkin.exml"},t.LoginLoadingUI=e,__reflect(e.prototype,"ui.LoginLoadingUI")}(ui||(ui={}));var ui;!function(t){var e="NETTIP.BUSY",i=function(i){function o(){return i.call(this,o.CUSTOM)||this}return __extends(o,i),o.prototype.onEnter=function(){i.prototype.onEnter.call(this),Singleton(NetCenter).on(NetCenter.EVT.ERROR,this.Event("onError")),Singleton(NetCenter).on(NetCenter.EVT.BUSY,this.Event("onBusy")),Singleton(NetCenter).on(NetCenter.EVT.CONN,this.Event("onConn")),Singleton(NetCenter).on(NetCenter.EVT.CLOSE,this.Event("onDisconn")),this.toState("gpIdle")},o.prototype.playAni=function(){this.toState("gpBusy"),this.playAnimationLoop("busy")},o.prototype.onBusy=function(t){return t?(Singleton(Timer).cancel(this,e),void Singleton(Timer).after(500,this.Event(e,this.playAni))):this.onIdle()},o.prototype.onIdle=function(){this.toState("gpIdle"),Singleton(Timer).cancel(this,e),this.stopAnimationLoop("busy")},o.prototype.onConn=function(){this.onIdle()},o.prototype.onDisconn=function(){this.toState("gpDisconn"),Singleton(Timer).cancel(this,e),this.stopAnimationLoop("busy")},o.prototype.onError=function(){this.toState("gpRelogin"),Singleton(Timer).cancel(this,e),this.stopAnimationLoop("busy")},o.prototype.onBtnReconn=function(){Singleton(NetCenter).connectServer(),console.log("onBtnReconn")},o.prototype.onBtnRelogin=function(){UIMgr.openOnce(t.Login),this.toState("gpIdle")},o.prototype.toState=function(t){var e=this,i=["gpBusy","gpDisconn","gpIdle","gpRelogin"];i.map(function(t){return e[t].visible=!1}),this[t].visible=!0},o}(UIBase);i.CUSTOM={skinName:"resource/ui/NetTipUISkin.exml",binding:(o={},o.btnReconn={method:"onBtnReconn"},o.btnRelogin={method:"onBtnRelogin"},o)},t.NetTip=i,__reflect(i.prototype,"ui.NetTip"),eui.sys.mixin(i,t.AnimatImpl);var o}(ui||(ui={}));var ui;!function(t){var e=function(t){function e(i){return t.call(this,e.CUSTOM)||this}return __extends(e,t),e.prototype.onEnter=function(){t.prototype.onEnter.call(this);var e=LogicMgr.get(logic.Login).getServerListInfo();this.serverList.addEventListener(eui.ItemTapEvent.ITEM_TAP,this.onItemTouch,this);var i=this.getData(e);this.refresh(i)},e.prototype.getData=function(t){for(var e=[],i=0;i<t.length;i++){var o=new logic.ServerInfo;o.name=t[i].name,o.ip=t[i].ip,o.port=t[i].port,o.id=t[i].id,e.push(o)}return e},e.prototype.refresh=function(t){this.serverList.dataProvider=new eui.ArrayCollection(t)},e.prototype.onItemTouch=function(t){this.removeFromParent(),LogicMgr.get(logic.Login).setCurServerInfo(this.serverList.selectedItem),LogicMgr.get(logic.Login).fireEvent(logic.Login.EVT.REFESH_SERVERINFO)},e}(UIBase);e.CUSTOM={closeBg:{alpha:.5,disable:!1},skinName:"resource/ui/ServerListUISkin.exml"},t.ServerList=e,__reflect(e.prototype,"ui.ServerList")}(ui||(ui={}));var ui;!function(t){var e=function(e,i){var o=new t.ActionMenu(e,i);return n=[i.pos.x,i.pos.y],o.x=n[0],o.y=n[1],i.root.addChild(o),o;var n},i=[{condition:function(t){return LogicMgr.get(logic.Build).isBuildMenu(t)},loader:function(e,i){return UIMgr.openOnce(t.BuildMenu,void 0,e,i)}},{condition:function(t){return!0},loader:e}],o=function(t){function e(){return t.call(this,e.CUSTOM)||this}return __extends(e,t),e.prototype.onEnter=function(){t.prototype.onEnter.call(this),LogicMgr.get(logic.World).on(logic.World.EVT.ENTER_MAP,this.Event("onEnterMap")),LogicMgr.get(logic.World).on(logic.World.EVT.SIGHT_UPDATE,this.Event("onSightUdpate")),LogicMgr.get(logic.World).on(logic.World.EVT.ACTOR_MOVE,this.Event("onActorMove")),this.createMap(config.MAP_URLS),this.manager=new world.Manager(LogicMgr.get(logic.World),this.map),this.onReSize();var e=RES.getRes("frame_jianzuxuanzhong_s1_png");this.selectedNode=new eui.Image(e),this.selectedNode.touchEnabled=!1,this.selectedNode.alpha=.3,this.map.getNode().addChild(this.selectedNode),this.selectedNode.anchorOffsetX=e.bitmapData.width/2,this.selectedNode.anchorOffsetY=e.bitmapData.height/2,this.onGpRest2MainCell()},e.prototype.onExit=function(){t.prototype.onExit.call(this),this.map=null,this.mapContainer.dispose(),this.mapContainer=null},e.prototype.createMap=function(t){var e=this;this.mapContainer=new MapScroller,this.mapContainer.buildMap(t[0],t.slice(1),this.gpMap),this.map=this.mapContainer.getMap(),this.map.registTapCallback(function(t){return e.onTagCell(t)}),this.map.registUpdateCallback(function(t){return e.onUpdateCells(t)}),this.mapContainer.registScrollCallback(function(){return e.updateDisplayLabel()})},e.prototype.onActorMove=function(t){this.manager.getArmyMgr().updatePath(t)},e.prototype.onSightUdpate=function(){var t=LogicMgr.get(logic.World);this.manager.getArmyMgr().updateData(t.getArmayData()),this.manager.getBuildMgr().updateData(t.getUnitData()),this.manager.getTabletMgr().updateData(t.getTabletData())},e.prototype.onTagCell=function(t){var e=this.map.world2cell(t.x,t.y),i=e[0],o=e[1];this.onSearchCellPos({x:i,y:o}),this.updateSelectedNode(t)},e.prototype.updateSelectedNode=function(t){var e=this.map.world2cell(t.x,t.y),i=this.map.cell2world(e[0],e[1]);this.selectedNode.x=i[0],this.selectedNode.y=i[1]},e.prototype.moveToCell=function(t,e,i){void 0===i&&(i=0);var o={target_point:{x:t,y:e,z:i}};NetMgr.get(msg.Map).send("m_map_get_view_obj_tos",o)},e.prototype.onUpdateCells=function(t){var e=this.map.getCenterCPos();LogicMgr.get(logic.World).getViewObjects(e[0],e[1]),LogicMgr.get(logic.World).setViewCells(t),this.updateDisplayLabel()},e.prototype.onSearchCellPos=function(t,e){var i=LogicMgr.get(logic.World).getUnitDataByPos(t);if(i){var o=this.manager.getGridData(i,t);this.onClickMap(o,e)}},e.prototype.onClickMap=function(t,e){this.closeItem();t.root,t.info,t.pos;t.param=e;for(var o=0,n=i;o<n.length;o++){var r=n[o];if(r.condition(t))return void(this.worldItem=r.loader(this,t))}},e.prototype.closeItem=function(){return this.worldItem?(this.closeWorldItem(),!0):!1},e.prototype.closeWorldItem=function(){this.worldItem&&(this.worldItem.parent&&this.worldItem.parent.removeChild(this.worldItem),this.worldItem=null)},e.prototype.getMap=function(){return this.map},e.prototype.getMapContainer=function(){return this.mapContainer},e.prototype.onReSize=function(){t.prototype.onReSize.call(this),this.mapContainer.setViewSize({width:this.width,height:this.height})},e.prototype.onGpRest2MainCell=function(){var t=LogicMgr.get(logic.Build).getMainBuildPos();this.mapContainer.setCell2Center(t.x,t.y)},e.prototype.updateDisplayLabel=function(){var t=LogicMgr.get(logic.Build).getMainBuildPos(),e=this.manager.getHelper().getDisplayInfo(t);if(this.gpDis.visible=e.show,e.show){var i=this.manager.getHelper().getDistance(t,{x:e.cPosCenter[0],y:e.cPosCenter[1]}),o=Math.round(e.angle/Math.PI*180);this.gpDis.rotation=o,i=Math.floor(i),this.lbDis.text=i+"公里",this.lbDis.rotation=90>o&&o>-90?0:180;var n=this.updateDistancePos(o);r=[n.x,n.y],this.gpDis.x=r[0],this.gpDis.y=r[1];var r}},e.prototype.updateDistancePos=function(t){var e=Math.round(this.width-this.gpDis.width/2),i=Math.round(this.gpDis.width/2),o=Math.round(this.height-this.gpDis.width/2),n=Math.round(this.gpDis.width/2),r=o-n,s=e-i,a={x:0,y:0};return 45>=t&&t>=-45?(a.x=e,a.y=o-(45-t)*r/90):135>=t&&t>45?(a.x=(135-t)*s/90+i,a.y=o):-45>t&&t>=-135?(a.x=(135+t)*s/90+i,a.y=n):-135>t&&t>=-180?(a.x=i,a.y=o-(225+t)*r/90):180>=t&&t>135&&(a.x=i,a.y=o-(t-135)*r/90),a},e}(UIBase);o.CUSTOM={skinName:"resource/ui/WorldUISkin.exml",binding:(n={},n.gpDis={method:"onGpRest2MainCell"},n)},t.World=o,__reflect(o.prototype,"ui.World");var n}(ui||(ui={}));